name: Behat and PHPUnit

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ "**" ]

jobs:
  phpunit:
    name: PHPUnit (PHP ${{ matrix.php }})
    runs-on: ubuntu-24.04
    timeout-minutes: 25
    strategy:
      fail-fast: false
      matrix:
        php: [ '7.4', '8.0', '8.1', '8.2', '8.3', '8.4' ]

    env:
      DB_HOST: 127.0.0.1
      DB_USER: root
      DB_PASSWORD: root
      DB_NAME: wp_test_${{ matrix.php }}
      WP_CORE_DIR: /tmp/wordpress/
      WP_TESTS_DIR: /tmp/wordpress-tests-lib
      WP_TESTS_PHPUNIT_POLYFILLS_PATH: /tmp/phpunit-deps/vendor/yoast/phpunit-polyfills
      COMPOSER_NO_INTERACTION: 1
      COMPOSER_NO_AUDIT: 1
      COMPOSER_PROCESS_TIMEOUT: 0

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Set up PHP ${{ matrix.php }}
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php }}
          tools: composer:v2
          coverage: none

      - name: Start MySQL
        run: |
          sudo systemctl start mysql
          mysql -uroot -proot -e "DROP DATABASE IF EXISTS \`${DB_NAME}\`; CREATE DATABASE \`${DB_NAME}\` CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;"

      # Avoid PHP >=8.1-only dev deps on 7.4/8.0, but still get autoload for the plugin.
      - name: Install Composer deps (compat mode on older PHP)
        run: |
          PHPV=$(php -r 'echo PHP_MAJOR_VERSION.".".PHP_MINOR_VERSION;')
          if [ "$PHPV" = "7.4" ] || [ "$PHPV" = "8.0" ]; then
            composer install --no-progress --no-interaction --no-dev
          else
            composer install --no-progress --no-interaction
          fi

      # Install the Yoast polyfills into a separate throwaway dir â€“ independent of repo lock
      - name: Ensure PHPUnit Polyfills
        run: |
          if [ ! -d /tmp/phpunit-deps/vendor/yoast/phpunit-polyfills ]; then
            composer create-project --no-dev --no-interaction yoast/phpunit-polyfills:^2 /tmp/phpunit-deps
          fi
          test -f /tmp/phpunit-deps/vendor/yoast/phpunit-polyfills/phpunitpolyfills-autoload.php

      - name: Make bootstrap executable
        run: chmod +x bin/phpunit-bootstrap.sh

      - name: Bootstrap WordPress test suite
        env:
          WP_VERSION: 6.8.3
        run: bin/phpunit-bootstrap.sh

      # Prefer project PHPUnit if present; otherwise fetch suitable phar
      - name: Run PHPUnit
        env:
          XDEBUG_MODE: off
        run: |
          if [ -x vendor/bin/phpunit ]; then
            vendor/bin/phpunit
          else
            PHPV=$(php -r 'echo PHP_MAJOR_VERSION.".".PHP_MINOR_VERSION;')
            if [ "$PHPV" = "8.4" ]; then
              curl -fsSL https://phar.phpunit.de/phpunit-10.phar -o phpunit.phar
            else
              curl -fsSL https://phar.phpunit.de/phpunit-9.phar -o phpunit.phar
            fi
            php ./phpunit.phar
          fi

  behat:
    name: Behat (SSP ${{ matrix.ssp }})
    runs-on: ubuntu-24.04
    timeout-minutes: 45
    strategy:
      fail-fast: false
      matrix:
        ssp: ['1.18.0', '2.0.0', '2.4.0']

    env:
      # plain env (not secrets)
      TERMINUS_SITE: wp-saml-auth
      SIMPLESAMLPHP_VERSION: ${{ matrix.ssp }}
      WORDPRESS_ADMIN_USERNAME: pantheon
      WORDPRESS_ADMIN_EMAIL: no-reply@getpantheon.com
      WORDPRESS_ADMIN_PASSWORD: pantheon
      COMPOSER_NO_INTERACTION: 1
      COMPOSER_NO_AUDIT: 1
      COMPOSER_PROCESS_TIMEOUT: 0
      WP_TESTS_DIR: /tmp/wordpress-tests-lib
      WP_CORE_DIR: /tmp/wordpress/

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      # Terminus 4 requires PHP 8.2+
      - name: Setup PHP 8.2
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          tools: composer:v2
          coverage: none

      # Compute a valid Multidev name:
      #   - remove dots
      #   - prefix "ci"
      #   - truncate to 11 chars by taking version digits and last 4 of run number
      - name: Compute Pantheon Multidev name
        run: |
          VER="${SIMPLESAMLPHP_VERSION//./}"        # e.g. 1180 -> 1.18.0
          SUFFIX=$(printf "%04d" $(( GITHUB_RUN_NUMBER % 10000 )) )
          # base "ci" + version digits (max 7) + 4 digit suffix => <= 11 chars
          BASE="ci${VER}"
          BASE="${BASE:0:7}"
          TERMINUS_ENV="${BASE}${SUFFIX}"
          echo "TERMINUS_ENV=${TERMINUS_ENV}" | tee -a "$GITHUB_ENV"
          echo "Computed env: $TERMINUS_ENV"

      - name: Install Terminus
        uses: pantheon-systems/terminus-github-actions@v1
        with:
          pantheon-machine-token: ${{ secrets.TERMINUS_TOKEN }}

      - name: Start ssh-agent and add key (for SFTP)
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SITE_OWNER_SSH_PRIVATE_KEY }}

      - name: Make prepare script executable
        run: chmod +x bin/behat-prepare.sh || true

      - name: Prepare Multidev + SimpleSAMLphp + plugin
        run: bin/behat-prepare.sh

      - name: Run Behat
        env:
          XDEBUG_MODE: off
        run: vendor/bin/behat --colors --no-interaction

