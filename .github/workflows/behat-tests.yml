name: Behat and PHPUnit

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ "**" ]

jobs:
  phpunit:
    name: PHPUnit (PHP ${{ matrix.php }})
    runs-on: ubuntu-24.04
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        php: [ '7.4', '8.0', '8.1', '8.2', '8.3', '8.4' ]
        include:
          - php: '8.4'
            experimental: true
    continue-on-error: ${{ matrix.experimental == true }}

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: wp_test
        ports: [ "3306:3306" ]
        options: >-
          --health-cmd="mysqladmin ping -h 127.0.0.1 -proot"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=10

    env:
      COMPOSER_PROCESS_TIMEOUT: 0
      COMPOSER_NO_INTERACTION: 1
      COMPOSER_NO_AUDIT: 1
      DB_HOST: 127.0.0.1
      DB_USER: root
      DB_PASSWORD: root
      DB_NAME: wp_test_${{ matrix.php }}
      WP_TESTS_DIR: /tmp/wordpress-tests-lib
      WP_CORE_DIR: /tmp/wordpress/

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Setup PHP ${{ matrix.php }}
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php }}
          tools: composer:v2
          coverage: none
          extensions: mysqli

      - name: Composer cache
        uses: actions/cache@v4
        with:
          path: |
            vendor
            ~/.composer/cache
          key: composer-${{ runner.os }}-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            composer-${{ runner.os }}-

      # IMPORTANT:
      # - On PHP < 8.1, do NOT install dev deps from your lock (they require PHP >= 8.1).
      # - We install only prod deps, then pull Yoast Polyfills into a separate temp vendor dir.
      - name: Install Composer dependencies (prod) + polyfills
        shell: bash
        run: |
          set -euo pipefail
          PHPV=$(php -r 'echo PHP_MAJOR_VERSION.".".PHP_MINOR_VERSION;')

          # Always install prod deps from your lock.
          composer install --no-progress --no-interaction --no-dev

          # For tests, we need Yoast PHPUnit Polyfills everywhere.
          # Install it into a separate working dir that won't conflict with your lock.
          mkdir -p /tmp/phpunit-deps
          composer init --no-interaction --name tmp/phpunit-deps --working-dir=/tmp/phpunit-deps >/dev/null 2>&1
          composer config platform.php "$PHPV" --working-dir=/tmp/phpunit-deps
          composer require --no-progress --no-interaction --working-dir=/tmp/phpunit-deps yoast/phpunit-polyfills:^2

          echo "WP_TESTS_PHPUNIT_POLYFILLS_PATH=/tmp/phpunit-deps/vendor/yoast/phpunit-polyfills" >> $GITHUB_ENV

      - name: Make CI scripts executable
        run: chmod +x bin/phpunit-bootstrap.sh || true

      - name: Bootstrap WP test environment
        run: bin/phpunit-bootstrap.sh

      - name: Run PHPUnit
        env:
          XDEBUG_MODE: off
        run: |
          if [ -x vendor/bin/phpunit ]; then
            vendor/bin/phpunit
          else
            # Fallback to phar per runtime for PHP 8.4, otherwise 9.x is fine.
            PHPV=$(php -r 'echo PHP_MAJOR_VERSION.".".PHP_MINOR_VERSION;')
            if [ "$PHPV" = "8.4" ]; then
              curl -fsSL https://phar.phpunit.de/phpunit-10.phar -o phpunit.phar
            else
              curl -fsSL https://phar.phpunit.de/phpunit-9.phar -o phpunit.phar
            fi
            php ./phpunit.phar
          fi

  behat:
    name: Behat (SSP ${{ matrix.ssp }})
    runs-on: ubuntu-24.04
    timeout-minutes: 45
    strategy:
      fail-fast: false
      matrix:
        ssp: [ '1.18.0', '2.0.0', '2.4.0' ]

    env:
      TERMINUS_SITE: wp-saml-auth        # <-- set to your site name
      TERMINUS_ENV: ci${{ matrix.ssp }}${{ github.run_number }}${{ github.run_attempt }}
      SIMPLESAMLPHP_VERSION: ${{ matrix.ssp }}

      # WP creds for the test user (kept as env â€” not secrets)
      WORDPRESS_ADMIN_USERNAME: pantheon
      WORDPRESS_ADMIN_EMAIL: no-reply@getpantheon.com
      WORDPRESS_ADMIN_PASSWORD: pantheon

      # Generic CI env
      COMPOSER_PROCESS_TIMEOUT: 0
      COMPOSER_NO_INTERACTION: 1
      COMPOSER_NO_AUDIT: 1
      WP_TESTS_DIR: /tmp/wordpress-tests-lib
      WP_CORE_DIR: /tmp/wordpress/

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      # PHP 8.2 so Terminus 4 works (the action downloads v4.x)
      - name: Setup PHP 8.2
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          tools: composer:v2
          coverage: none

      - name: Composer cache
        uses: actions/cache@v4
        with:
          path: |
            vendor
            ~/.composer/cache
          key: composer-${{ runner.os }}-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            composer-${{ runner.os }}-

      - name: Install Composer dependencies
        run: composer install --no-progress --no-interaction

      - name: Install Terminus
        uses: pantheon-systems/terminus-github-actions@v1
        with:
          pantheon-machine-token: ${{ secrets.TERMINUS_TOKEN }}

      - name: Start ssh-agent and add key (for SFTP upload)
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SITE_OWNER_SSH_PRIVATE_KEY }}

      - name: Make Behat script executable
        run: chmod +x bin/behat-prepare.sh || true

      - name: Prepare Multidev + SimpleSAMLphp + plugin
        run: bin/behat-prepare.sh

      - name: Run Behat
        env:
          XDEBUG_MODE: off
        run: vendor/bin/behat --colors --no-interaction
