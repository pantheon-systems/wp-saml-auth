name: Behat tests

on:
  push:
    branches: [ develop ]
  pull_request:

permissions:
  contents: read

defaults:
  run:
    shell: bash

env:
  WP_TESTS_DIR: /tmp/wordpress-tests-lib
  WP_CORE_DIR: /tmp/wordpress
  DB_HOST: 127.0.0.1
  DB_USER: root
  DB_PASSWORD: root
  DB_NAME: wordpress_test
  COMPOSER_PROCESS_TIMEOUT: 0
  COMPOSER_NO_INTERACTION: 1
  COMPOSER_NO_AUDIT: 1

jobs:
  phpunit-74:
    name: "PHPUnit (PHP 7.4)"
    runs-on: ubuntu-20.04
    steps:
      - uses: actions/checkout@v4

      - uses: shivammathur/setup-php@v2
        with:
          php-version: '7.4'
          coverage: none
          tools: phpunit
          extensions: mbstring, intl, xml, dom, curl, json, mysqli

      - name: Composer cache
        uses: actions/cache@v4
        with:
          path: ~/.composer/cache/files
          key: composer-${{ runner.os }}-${{ hashFiles('**/composer.lock') }}
          restore-keys: composer-${{ runner.os }}-

      - name: Install Composer deps
        run: composer install --no-progress --prefer-dist

      - name: Build PHP wrapper (with SimpleSAML mock)
        run: bin/ci/make-php-wrapper.sh

      - name: Install WP tests (DB + Core + Polyfills path)
        run: bin/ci/wp-tests-install.sh

      - name: Run PHPUnit (7.4)
        env:
          PHP_VERSION: "7.4"
        run: bin/ci/run-phpunit.sh

  phpunit-8x:
    name: "PHPUnit (PHP ${{ matrix.php }})"
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        php: ['8.0', '8.1', '8.2', '8.3']
    steps:
      - uses: actions/checkout@v4

      - uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php }}
          coverage: none
          extensions: mbstring, intl, xml, dom, curl, json, mysqli

      - name: Composer cache
        uses: actions/cache@v4
        with:
          path: ~/.composer/cache/files
          key: composer-${{ runner.os }}-${{ hashFiles('**/composer.lock') }}
          restore-keys: composer-${{ runner.os }}-

      - name: Install Composer deps
        run: composer install --no-progress --prefer-dist

      - name: Build PHP wrapper (with SimpleSAML mock)
        run: bin/ci/make-php-wrapper.sh

      - name: Install WP tests (DB + Core + Polyfills path)
        run: bin/ci/wp-tests-install.sh

      - name: Run PHPUnit (${{ matrix.php }})
        env:
          PHP_VERSION: "${{ matrix.php }}"
        run: bin/ci/run-phpunit.sh

  behat:
    name: "Behat (SSP ${{ matrix.ssp }})"
    runs-on: ubuntu-22.04
    needs: [phpunit-74, phpunit-8x]
    strategy:
      fail-fast: false
      matrix:
        ssp: ['1.18.0', '2.0.0', '2.4.0']
    env:
      TERMINUS_RELEASE: 4.1.0
      TERMINUS_SITE: wp-saml-auth
      # Each job should vary ENV to avoid collisions; we derive one from GITHUB_SHA
      TERMINUS_ENV: ci${{ matrix.ssp }}${{ github.sha.substr(0,8) }}
    steps:
      - uses: actions/checkout@v4

      - name: Install Composer deps (for Behat)
        run: composer install --no-progress --prefer-dist

      - name: Install Terminus
        run: |
          curl -L https://github.com/pantheon-systems/terminus/releases/download/${TERMINUS_RELEASE}/terminus.phar -o terminus
          chmod +x terminus
          sudo mv terminus /usr/local/bin/terminus
          terminus --version

      - name: Authenticate Terminus
        env:
          TERMINUS_TOKEN: ${{ secrets.TERMINUS_TOKEN }}
        run: |
          terminus auth:login --machine-token="$TERMINUS_TOKEN"
          terminus auth:whoami

      - name: Ensure Multidev exists (create or wipe)
        id: ensure
        run: |
          SITE_ENV=$(bin/ci/terminus-ensure-env.sh)
          echo "site_env=${SITE_ENV}" >> "$GITHUB_OUTPUT"

      - name: Prepare SimpleSAMLphp (download/copy for tests if needed)
        env:
          SIMPLESAMLPHP_VERSION: ${{ matrix.ssp }}
        run: bin/ci/simplesaml-download.sh

      - name: Behat Prepare
        env:
          SIMPLESAMLPHP_VERSION: ${{ matrix.ssp }}
          # Pass explicit env pieces; scripts in repo expect these:
          TERMINUS_SITE: ${{ env.TERMINUS_SITE }}
          TERMINUS_ENV: ${{ env.TERMINUS_ENV }}
        run: |
          if [[ "${SIMPLESAMLPHP_VERSION}" == "1.18.0" ]]; then
            bash ./bin/1.18/behat-prepare-simplesaml1.18.0.sh
          else
            bash ./bin/behat-prepare.sh
          fi

      - name: Behat Run
        env:
          WORDPRESS_ADMIN_USERNAME: pantheon
          WORDPRESS_ADMIN_EMAIL: no-reply@getpantheon.com
          WORDPRESS_ADMIN_PASSWORD: ${{ secrets.WORDPRESS_ADMIN_PASSWORD }}
          SIMPLESAMLPHP_VERSION: ${{ matrix.ssp }}
          TERMINUS_SITE: ${{ env.TERMINUS_SITE }}
          TERMINUS_ENV: ${{ env.TERMINUS_ENV }}
        run: bash ./bin/behat-test.sh --strict

      - name: Always cleanup Multidevs (and prune)
        if: always()
        env:
          TERMINUS_SITE: ${{ env.TERMINUS_SITE }}
          TERMINUS_ENV: ${{ env.TERMINUS_ENV }}
        run: bash ./bin/behat-cleanup.sh
