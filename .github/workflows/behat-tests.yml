name: PHPUnit & Behat

on:
  pull_request:
  workflow_dispatch: {}

jobs:
  phpunit:
    name: PHPUnit (PHP ${{ matrix.php }})
    runs-on: ubuntu-latest
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        php: ['7.4', '8.0', '8.1', '8.2', '8.3']

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_AUTHENTICATION_PLUGIN: mysql_native_password
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -h 127.0.0.1 -uroot -proot"
          --health-interval=5s
          --health-timeout=5s
          --health-retries=10
          --health-start-period=10s

    env:
      DB_HOST: 127.0.0.1
      DB_USER: root
      DB_PASSWORD: root
      WP_CORE_DIR: /tmp/wordpress/
      WP_TESTS_DIR: /tmp/wordpress-tests-lib
      WP_TESTS_PHPUNIT_POLYFILLS_PATH: /tmp/phpunit-deps
      COMPOSER_NO_INTERACTION: 1
      COMPOSER_NO_AUDIT: 1
      COMPOSER_PROCESS_TIMEOUT: 0
      WP_VERSION: 6.8.3

    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Setup PHP ${{ matrix.php }}
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php }}
          extensions: mysqli, intl, mbstring
          tools: composer:v2
          coverage: none

      - name: Install MySQL client
        run: |
          sudo apt-get update -y
          sudo apt-get install -y mysql-client

      - name: Compute DB name per PHP
        run: |
          PV="${{ matrix.php }}"
          SAFE="${PV/./}"
          echo "DB_NAME=wp_test_${SAFE}" >> "$GITHUB_ENV"

      - name: Create database
        run: |
          echo "Creating database $DB_NAME"
          mysql -h 127.0.0.1 -uroot -proot -e "DROP DATABASE IF EXISTS \`$DB_NAME\`; CREATE DATABASE \`$DB_NAME\` CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;"

      - name: Require wpunit-helpers (if missing)
        run: |
          if ! composer show -D pantheon-systems/wpunit-helpers >/dev/null 2>&1; then
            composer require --dev pantheon-systems/wpunit-helpers:^2 --no-interaction --no-progress
          fi

      - name: Update wpunit-helpers to latest
        run: composer update pantheon-systems/wpunit-helpers --no-interaction --no-progress

      - name: Install deps
        run: composer install --no-interaction --no-progress

      - name: Install WP-CLI (if needed)
        run: |
          if ! command -v wp >/dev/null 2>&1; then
            curl -fsSL https://raw.githubusercontent.com/wp-cli/builds/gh-pages/phar/wp-cli.phar -o wp
            chmod +x wp
            echo "$PWD" >> "$GITHUB_PATH"
          fi

      - name: Install WordPress test framework
        run: |
          bash bin/install-wp-tests.sh \
            --dbname="$DB_NAME" \
            --dbuser="$DB_USER" \
            --dbpass="$DB_PASSWORD" \
            --dbhost="$DB_HOST" \
            --version="$WP_VERSION" \
            --skip-db=true

      - name: Copy plugin & activate
        env:
          WP_CORE_DIR: /tmp/wordpress
          PLUGIN_SLUG: wp-saml-auth
        run: |
          set -euo pipefail
          PLUG_DIR="$WP_CORE_DIR/wp-content/plugins/$PLUGIN_SLUG"
          mkdir -p "$PLUG_DIR"
          rsync -a --delete ./ "$PLUG_DIR/" --exclude .git --exclude .github --exclude node_modules
          if [ -f "$PLUG_DIR/composer.json" ]; then
            ( cd "$PLUG_DIR" && composer install --no-interaction --no-progress )
          fi
          wp plugin activate "$PLUGIN_SLUG" --path="$WP_CORE_DIR"

      - name: Force OneLogin (internal) provider for tests
        env:
          WP_CORE_DIR: /tmp/wordpress
        run: |
          set -euo pipefail
          
          # 0) Ensure the plugin is active (will no-op if already active)
          wp plugin activate wp-saml-auth --path="$WP_CORE_DIR" >/dev/null 2>&1 || true
          
          # 1) Resolve the option key safely
          OPT_KEY="$(wp option list --search=wp_saml_auth_ --field=option_name --path="$WP_CORE_DIR" | head -n1 || true)"
          if [ -z "${OPT_KEY:-}" ]; then
          OPT_KEY="wp_saml_auth_options"
          fi
          
          # 2) Ensure the option exists as a serialized array
          if ! wp option get "$OPT_KEY" --path="$WP_CORE_DIR" >/dev/null 2>&1; then
          wp option add "$OPT_KEY" '{}' --format=json --path="$WP_CORE_DIR"
          fi
          
          # 3) Read current settings (JSON), merge desired bits, write back
          CUR="$(wp option get "$OPT_KEY" --format=json --path="$WP_CORE_DIR" 2>/dev/null || echo '{}')"
            
          NEW="$(php -r '
            $c=json_decode(stream_get_contents(STDIN), true) ?: [];
            $c["connection_type"]="internal";
            $c["internal_config"]=$c["internal_config"]??[];
            $c["internal_config"]["strict"]=true;
            $c["internal_config"]["debug"]=false;
            $c["internal_config"]["baseurl"]=$c["internal_config"]["baseurl"]??"http://example.test";
            $c["internal_config"]["sp"]["entityId"]=$c["internal_config"]["sp"]["entityId"]??"urn:example";
            $c["internal_config"]["sp"]["assertionConsumerService"]["url"]=
            $c["internal_config"]["sp"]["assertionConsumerService"]["url"]??"http://example.test/wp-login.php";
            // Dummy IdP endpoints to satisfy structure during unit tests
            $c["internal_config"]["idp"]["entityId"]=$c["internal_config"]["idp"]["entityId"]??"urn:dummy-idp";
            $c["internal_config"]["idp"]["singleSignOnService"]["url"]=
            $c["internal_config"]["idp"]["singleSignOnService"]["url"]??"https://idp.invalid/sso";
            $c["internal_config"]["idp"]["singleLogoutService"]["url"]=
            $c["internal_config"]["idp"]["singleLogoutService"]["url"]??"https://idp.invalid/slo";
            echo json_encode($c);
            ' <<<"$CUR")"
          
          wp option update "$OPT_KEY" "$NEW" --format=json --path="$WP_CORE_DIR"
          
          # 4) Verify
          wp option get "$OPT_KEY" --format=json --path="$WP_CORE_DIR" | grep -q '"connection_type":"internal"'

      - name: Force internal provider early (via wp-config include) â€” no MU plugin
        env:
          WP_CORE_DIR: /tmp/wordpress
        run: |
          set -euo pipefail
          # 1) Drop a tiny config that forces connection_type=internal
          cat > /tmp/ci-wpsaml-config.php <<'PHP'
          <?php
          // Runs before plugins (loaded by wp-config.php below).
          add_filter('wp_saml_auth_option', function ($value, $option) {
            return $option === 'connection_type' ? 'internal' : $value;
          }, 10, 2);
          PHP
      
          # 2) Ensure wp-config loads it (idempotent, not an mu-plugin)
          if ! grep -q "ci-wpsaml-config.php" "$WP_CORE_DIR/wp-config.php"; then
            printf "\n// CI: force WP SAML Auth internal provider (no MU plugin)\n@include '/tmp/ci-wpsaml-config.php';\n" >> "$WP_CORE_DIR/wp-config.php"
          fi

      - name: PHPUnit
        run: vendor/bin/phpunit --do-not-cache-result

#      - name: Run PHPUnit (stable only)
#        run: bash bin/phpunit-test.sh --skip-nightly

  behat:
    name: Behat (SSP ${{ matrix.ssp }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        ssp: ["1.18.0", "2.0.0", "2.4.0"]

    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          persist-credentials: false
          submodules: recursive
          lfs: false

      - name: Setup PHP 8.2
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.2"
          tools: composer:v2
          coverage: none

      - name: Install Terminus
        uses: pantheon-systems/terminus-github-actions@v1
        with:
          pantheon-machine-token: ${{ secrets.TERMINUS_TOKEN }}

      - name: SSH agent (Pantheon)
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SITE_OWNER_SSH_PRIVATE_KEY }}
          log-public-key: true

      - name: Configure SSH (no strict host key checking)
        run: |
          mkdir -p ~/.ssh
          printf "Host *\n  StrictHostKeyChecking no\n  UserKnownHostsFile=/dev/null\n" > ~/.ssh/config

      - name: Set Pantheon site id
        run: echo "TERMINUS_SITE=wp-saml-auth" >> $GITHUB_ENV

      - name: Compute Pantheon env vars
        env:
          SSP: ${{ matrix.ssp }}
          TERMINUS_SITE: ${{ env.TERMINUS_SITE }}
        run: |
          set -e
          ssp_num="${SSP//./}"
          suffix=$(printf "%04d" $(( GITHUB_RUN_NUMBER % 10000 )) )
          env_id="ci${ssp_num}${suffix}"
          TERMINUS_ENV="${env_id:0:10}"
          echo "TERMINUS_ENV=$TERMINUS_ENV" >> $GITHUB_ENV
          echo "SIMPLESAMLPHP_VERSION=$SSP" >> $GITHUB_ENV
          echo "PANTHEON_SITE_URL=${TERMINUS_ENV}-${TERMINUS_SITE}.pantheonsite.io" >> $GITHUB_ENV
          echo "Using env: $TERMINUS_SITE.$TERMINUS_ENV -> https://${TERMINUS_ENV}-${TERMINUS_SITE}.pantheonsite.io"

      - name: Install Composer deps
        run: composer install --no-progress --no-interaction

      - name: Prepare Pantheon environment
        env:
          WORDPRESS_ADMIN_USERNAME: pantheon
          WORDPRESS_ADMIN_EMAIL: no-reply@getpantheon.com
          WORDPRESS_ADMIN_PASSWORD: pantheon
        run: |
          set -eux
          if [ "${{ matrix.ssp }}" = "1.18.0" ]; then
            # Ensure the 1.18 script exists under your repo path
            test -f bin/1.18/behat-prepare-simplesaml1.18.0.sh

            # Patch the hard-coded WORKING_DIR inside the script to the current workspace
            sed -i 's|^WORKING_DIR=.*|WORKING_DIR="'"$GITHUB_WORKSPACE"'"|g' bin/1.18/behat-prepare-simplesaml1.18.0.sh

            # Run
            bash bin/1.18/behat-prepare-simplesaml1.18.0.sh
          else
            bash bin/behat-prepare.sh
          fi

      - name: Wait for Pantheon workflow
        run: |
          SITE_ENV="${TERMINUS_SITE}.${TERMINUS_ENV}"
          terminus workflow:wait "$SITE_ENV"

      - name: Wait until site responds
        run: |
          set -e
          URL="https://${PANTHEON_SITE_URL}"
          echo "Waiting for $URL ..."
          for i in $(seq 1 60); do
            if curl -fsSL -o /dev/null "$URL"; then
              echo "OK"; exit 0
            fi
            sleep 5
          done
          echo "Site never became ready: $URL"
          exit 1

      - name: Run Behat
        env:
          BEHAT_PARAMS: >-
            {"extensions":{"Behat\\MinkExtension":{"base_url":"https://${{ env.PANTHEON_SITE_URL }}"}}}
          PANTHEON_SITE_URL: ${{ env.PANTHEON_SITE_URL }}
          WORDPRESS_ADMIN_USERNAME: pantheon
          WORDPRESS_ADMIN_EMAIL: no-reply@getpantheon.com
          WORDPRESS_ADMIN_PASSWORD: pantheon
          XDEBUG_MODE: off
        run: |
          vendor/bin/behat --colors --no-interaction
