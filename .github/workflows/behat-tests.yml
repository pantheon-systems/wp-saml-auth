name: PHPUnit & Behat

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ '**' ]

jobs:
  phpunit:
    name: PHPUnit (PHP ${{ matrix.php }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        php: [ '7.4', '8.0', '8.1', '8.2', '8.3', '8.4' ]
    env:
      DB_HOST: 127.0.0.1
      DB_USER: root
      DB_PASSWORD: root
      WP_CORE_DIR: /tmp/wordpress/
      WP_TESTS_DIR: /tmp/wordpress-tests-lib
      WP_TESTS_PHPUNIT_POLYFILLS_PATH: /tmp/phpunit-deps
      COMPOSER_NO_INTERACTION: 1
      COMPOSER_NO_AUDIT: 1
      COMPOSER_PROCESS_TIMEOUT: 0

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Setup PHP ${{ matrix.php }}
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php }}
          coverage: none
          tools: composer
          extensions: mysqli

      - name: Start MySQL
        run: |
          sudo systemctl start mysql
          mysql -uroot -proot -e "CREATE DATABASE IF NOT EXISTS wp_test_${{ matrix.php//./ }} DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;"

      - name: Install Subversion (for WP tests checkout)
        run: sudo apt-get update && sudo apt-get install -y subversion

      - name: Composer install (project)
        run: composer install --no-progress --no-interaction

      - name: Prepare PHPUnit deps (Yoast Polyfills to /tmp/phpunit-deps)
        run: |
          if [ ! -d /tmp/phpunit-deps/vendor/yoast/phpunit-polyfills ]; then
            composer create-project --no-dev --no-interaction yoast/phpunit-polyfills:^2 /tmp/phpunit-deps
          fi
          test -f /tmp/phpunit-deps/vendor/yoast/phpunit-polyfills/phpunitpolyfills-autoload.php

      - name: Bootstrap WordPress test lib & core
        env:
          DB_NAME: wp_test_${{ matrix.php//./ }}
          WP_VERSION: 6.8.3
        run: |
          bash bin/phpunit-bootstrap.sh

      - name: Run PHPUnit
        env:
          DB_NAME: wp_test_${{ matrix.php//./ }}
          XDEBUG_MODE: off
        run: |
          if [ -x vendor/bin/phpunit ]; then
            vendor/bin/phpunit
          else
            PHPV=$(php -r 'echo PHP_MAJOR_VERSION.".".PHP_MINOR_VERSION;')
            if [ "$PHPV" = "8.4" ]; then
              curl -fsSL https://phar.phpunit.de/phpunit-10.phar -o phpunit.phar
            else
              curl -fsSL https://phar.phpunit.de/phpunit-9.phar -o phpunit.phar
            fi
            php ./phpunit.phar
          fi

  behat:
    name: Behat (SSP ${{ matrix.ssp }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        ssp: ['1.18.0','2.0.0','2.4.0']
    env:
      COMPOSER_NO_INTERACTION: 1
      COMPOSER_NO_AUDIT: 1
      COMPOSER_PROCESS_TIMEOUT: 0
      WP_CORE_DIR: /tmp/wordpress/
      WP_TESTS_DIR: /tmp/wordpress-tests-lib
      WORDPRESS_ADMIN_USERNAME: pantheon
      WORDPRESS_ADMIN_EMAIL: no-reply@getpantheon.com
      WORDPRESS_ADMIN_PASSWORD: pantheon

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      # Terminus v4 requires PHP â‰¥ 8.2. Use a job-local PHP runtime just for CLI.
      - name: Setup PHP 8.2 (for Terminus CLI)
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          coverage: none
          tools: composer

      - name: Install Terminus
        uses: pantheon-systems/terminus-github-actions@v1
        with:
          pantheon-machine-token: ${{ secrets.TERMINUS_TOKEN }}

      - name: Configure SSH for Pantheon
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: |
            ${{ secrets.SITE_OWNER_SSH_PRIVATE_KEY }}
        # Preload Pantheon codeserver host key to avoid host key prompts
      - name: Add Pantheon host keys
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -p 2222 codeserver.dev.*.drush.in >> ~/.ssh/known_hosts 2>/dev/null || true
          ssh-keyscan -p 2222 codeserver.live.*.drush.in >> ~/.ssh/known_hosts 2>/dev/null || true
          ssh-keyscan -p 2222 codeserver.test.*.drush.in >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Set Pantheon environment variables
        env:
          SSP: ${{ matrix.ssp }}
          TERMINUS_SITE_SECRET: ${{ secrets.PANTHEON_SITE }}
        run: |
          set -e
          if [ -z "$TERMINUS_SITE_SECRET" ]; then
            echo "PANTHEON_SITE secret is missing"; exit 1;
          fi
          export TERMINUS_SITE="$TERMINUS_SITE_SECRET"
          # Build a <=10 char, dns-safe env: ci + digits-only of ssp + 4-digit run suffix
          ssp_num="${SSP//./}"
          suffix=$(printf "%04d" $(( GITHUB_RUN_NUMBER % 10000 )) )
          env_id="ci${ssp_num}${suffix}"
          TERMINUS_ENV="${env_id:0:10}"
          echo "TERMINUS_SITE=$TERMINUS_SITE" >> $GITHUB_ENV
          echo "TERMINUS_ENV=$TERMINUS_ENV" >> $GITHUB_ENV
          echo "SIMPLESAMLPHP_VERSION=$SSP" >> $GITHUB_ENV
          echo "PANTHEON_SITE_URL=${TERMINUS_ENV}-${TERMINUS_SITE}.pantheonsite.io" >> $GITHUB_ENV
          echo "Using env: $TERMINUS_SITE.$TERMINUS_ENV"

      - name: Composer install (for Behat)
        run: composer install --no-progress --no-interaction

      # Use the right prepare script per SSP version:
      - name: Prepare Pantheon env (SSP 1.18.0)
        if: matrix.ssp == '1.18.0'
        env:
          TERMINUS_SITE: ${{ env.TERMINUS_SITE }}
          TERMINUS_ENV: ${{ env.TERMINUS_ENV }}
          SIMPLESAMLPHP_VERSION: ${{ matrix.ssp }}
          WORDPRESS_ADMIN_USERNAME: ${{ env.WORDPRESS_ADMIN_USERNAME }}
          WORDPRESS_ADMIN_EMAIL: ${{ env.WORDPRESS_ADMIN_EMAIL }}
          WORDPRESS_ADMIN_PASSWORD: ${{ env.WORDPRESS_ADMIN_PASSWORD }}
        run: |
          bash bin/1.18/behat-prepare.sh

      - name: Prepare Pantheon env (SSP 2.x)
        if: matrix.ssp != '1.18.0'
        env:
          TERMINUS_SITE: ${{ env.TERMINUS_SITE }}
          TERMINUS_ENV: ${{ env.TERMINUS_ENV }}
          SIMPLESAMLPHP_VERSION: ${{ matrix.ssp }}
          WORDPRESS_ADMIN_USERNAME: ${{ env.WORDPRESS_ADMIN_USERNAME }}
          WORDPRESS_ADMIN_EMAIL: ${{ env.WORDPRESS_ADMIN_EMAIL }}
          WORDPRESS_ADMIN_PASSWORD: ${{ env.WORDPRESS_ADMIN_PASSWORD }}
        run: |
          bash bin/behat-prepare.sh

      # Behat needs BASE URL; contexts read PANTHEON_SITE_URL from env
      - name: Run Behat
        env:
          TERMINUS_SITE: ${{ env.TERMINUS_SITE }}
          TERMINUS_ENV: ${{ env.TERMINUS_ENV }}
          SIMPLESAMLPHP_VERSION: ${{ matrix.ssp }}
          PANTHEON_SITE_URL: ${{ env.PANTHEON_SITE_URL }}
          XDEBUG_MODE: off
          BEHAT_PARAMS: >-
            {"extensions":{"Behat\\MinkExtension":{"base_url":"https://${{ env.PANTHEON_SITE_URL }}"}}}
        run: |
          vendor/bin/behat --colors --no-interaction
