name: Behat and PHPUnit

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  phpunit:
    name: PHPUnit (PHP ${{ matrix.php }})
    runs-on: ubuntu-latest
    timeout-minutes: 25
    strategy:
      fail-fast: false
      matrix:
        php: ['7.4', '8.0', '8.1', '8.2', '8.3', '8.4']
    env:
      DB_HOST: 127.0.0.1
      DB_USER: root
      DB_PASSWORD: root
      DB_NAME: wp_test_${{ matrix.php }}
      WP_CORE_DIR: /tmp/wordpress/
      WP_TESTS_DIR: /tmp/wordpress-tests-lib
      WP_TESTS_PHPUNIT_POLYFILLS_PATH: /tmp/phpunit-deps
      COMPOSER_NO_INTERACTION: 1
      COMPOSER_NO_AUDIT: 1
      COMPOSER_PROCESS_TIMEOUT: 0

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Set up PHP ${{ matrix.php }}
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php }}
          tools: composer:v2
          coverage: none

      - name: Install system packages (svn, unzip)
        run: |
          sudo apt-get update
          sudo apt-get install -y subversion unzip

      - name: Start MySQL
        run: |
          sudo systemctl start mysql
          mysql -uroot -proot -e "DROP DATABASE IF EXISTS \`${DB_NAME}\`; CREATE DATABASE \`${DB_NAME}\` CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;"

      - name: Install Composer deps (avoid dev for 7.4/8.0)
        run: |
          PHPV=$(php -r 'echo PHP_MAJOR_VERSION.".".PHP_MINOR_VERSION;')
          if [ "$PHPV" = "7.4" ] || [ "$PHPV" = "8.0" ]; then
            composer install --no-progress --no-interaction --no-dev
          else
            composer install --no-progress --no-interaction
          fi

      - name: Ensure PHPUnit Polyfills (Yoast)
        run: |
          if [ ! -d /tmp/phpunit-deps ]; then
            composer create-project --no-dev --no-interaction yoast/phpunit-polyfills:^2 /tmp/phpunit-deps
          fi
          test -f /tmp/phpunit-deps/phpunitpolyfills-autoload.php

      - name: Make PHPUnit bootstrap executable
        run: chmod +x bin/phpunit-bootstrap.sh

      - name: Bootstrap WordPress test suite
        env:
          WP_VERSION: 6.8.3
        run: bin/phpunit-bootstrap.sh

      - name: Run PHPUnit
        env:
          XDEBUG_MODE: off
        run: |
          if [ -x vendor/bin/phpunit ]; then
            vendor/bin/phpunit
          else
            PHPV=$(php -r 'echo PHP_MAJOR_VERSION.".".PHP_MINOR_VERSION;')
            if [ "$PHPV" = "8.4" ]; then
              curl -fsSL https://phar.phpunit.de/phpunit-10.phar -o phpunit.phar
            else
              curl -fsSL https://phar.phpunit.de/phpunit-9.phar -o phpunit.phar
            fi
            php ./phpunit.phar
          fi

  behat:
    name: Behat (SSP ${{ matrix.ssp }})
    runs-on: ubuntu-latest
    timeout-minutes: 45
    strategy:
      fail-fast: false
      matrix:
        ssp: ['1.18.0', '2.0.0', '2.4.0']

    env:
      TERMINUS_SITE: wp-saml-auth
      SIMPLESAMLPHP_VERSION: ${{ matrix.ssp }}
      WORDPRESS_ADMIN_USERNAME: pantheon
      WORDPRESS_ADMIN_EMAIL: no-reply@getpantheon.com
      WORDPRESS_ADMIN_PASSWORD: pantheon
      COMPOSER_NO_INTERACTION: 1
      COMPOSER_NO_AUDIT: 1
      COMPOSER_PROCESS_TIMEOUT: 0
      WP_TESTS_DIR: /tmp/wordpress-tests-lib
      WP_CORE_DIR: /tmp/wordpress/

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Setup PHP 8.2 for Terminus & Behat
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          tools: composer:v2
          coverage: none

      - name: Install Composer deps (dev)
        run: composer install --no-progress --no-interaction

      - name: Compute Pantheon Multidev name (no dots, <=11 chars)
        run: |
          VER="${SIMPLESAMLPHP_VERSION//./}"       # eg 1.18.0 -> 1180
          SUFFIX=$(printf "%04d" $(( GITHUB_RUN_NUMBER % 10000 )) )
          BASE="ci${VER}"                           # eg ci1180
          BASE="${BASE:0:7}"                        # leave room for suffix
          TERMINUS_ENV="${BASE}${SUFFIX}"           # eg ci11800042
          echo "TERMINUS_ENV=${TERMINUS_ENV}" | tee -a "$GITHUB_ENV"
          echo "PANTHEON_SITE_URL=${TERMINUS_ENV}-${TERMINUS_SITE}.pantheonsite.io" | tee -a "$GITHUB_ENV"

      - name: Install Terminus (official action)
        uses: pantheon-systems/terminus-github-actions@v1
        with:
          pantheon-machine-token: ${{ secrets.TERMINUS_TOKEN }}

      - name: Start ssh-agent and add key (SFTP)
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SITE_OWNER_SSH_PRIVATE_KEY }}

      - name: Make prepare script executable
        run: chmod +x bin/behat-prepare.sh

      - name: Prepare Multidev + SimpleSAMLphp + plugin
        run: bin/behat-prepare.sh

      - name: Run Behat
        env:
          XDEBUG_MODE: off
        run: vendor/bin/behat --colors --no-interaction
