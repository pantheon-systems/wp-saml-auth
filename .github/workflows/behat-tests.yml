name: Behat & PHPUnit

on:
  push:
  pull_request:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * *"   # nightly

defaults:
  run:
    shell: bash

jobs:
  # ==============================
  # Behat (matrix: SimpleSAMLphp)
  # ==============================
  behat:
    # Skip scheduled runs unless branch is master (Circle's nightly behavior)
    if: ${{ github.event_name != 'schedule' || github.ref_name == 'master' }}
    name: Test with SimpleSAMLphp ${{ matrix.simplesamlphp_version }}
    runs-on: ubuntu-latest

    # Run inside the same container you used on CircleCI
    container:
      image: quay.io/pantheon-public/build-tools-ci:8.x-php8.2
      options: --user root

    env:
      # You can set these in repo/org secrets. These are optional in the logic below.
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      TERMINUS_TOKEN: ${{ secrets.TERMINUS_TOKEN }}
      # Keep parity with Circle variables / naming
      TERMINUS_SITE: wp-saml-auth
      # Emulate Circle's CIRCLE_BUILD_NUM with GH run number
      CIRCLE_BUILD_NUM: ${{ github.run_number }}

    strategy:
      fail-fast: false
      matrix:
        simplesamlphp_version: ["1.18.0", "2.0.0", "2.4.0"]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Cache Composer vendor
        uses: actions/cache@v4
        with:
          path: vendor
          key: composer-cache-v1-${{ hashFiles('composer.lock') }}
          restore-keys: |
            composer-cache-v1-

      - name: Install Composer dependencies
        run: composer install -n --prefer-dist

      - name: Generate WP admin password
        run: echo "$(openssl rand -hex 8)" > /tmp/WORDPRESS_ADMIN_PASSWORD

      - name: Set environment variables (Circle parity)
        run: |
          {
            echo "export TERMINUS_ENV=ci-${CIRCLE_BUILD_NUM}"
            echo "export SITE_ENV=wp-saml-auth.ci-${CIRCLE_BUILD_NUM}"
            echo "export WORDPRESS_ADMIN_USERNAME=pantheon"
            echo "export WORDPRESS_ADMIN_EMAIL=no-reply@getpantheon.com"
            echo "export WORDPRESS_ADMIN_PASSWORD=$(cat /tmp/WORDPRESS_ADMIN_PASSWORD)"
            echo "export SIMPLESAMLPHP_VERSION='${{ matrix.simplesamlphp_version }}'"
          } >> $GITHUB_ENV

      - name: Disable StrictHostKeyChecking for SSH
        run: |
          mkdir -p "$HOME/.ssh"
          echo "StrictHostKeyChecking no" >> "$HOME/.ssh/config"

      - name: Configure Composer GitHub OAuth (optional)
        run: |
          if [ -z "${GITHUB_TOKEN:-}" ]; then
            echo "GITHUB_TOKEN missing; assuming unauthenticated build"
            exit 0
          fi
          { composer config -g github-oauth.github.com "$GITHUB_TOKEN"; } &> /dev/null

      - name: Terminus auth (optional)
        run: |
          if [ -z "${TERMINUS_TOKEN:-}" ]; then
            echo "TERMINUS_TOKEN missing; assuming unauthenticated build"
            exit 0
          fi
          terminus auth:login --machine-token="$TERMINUS_TOKEN"

      - name: Save environment name for cleanup
        run: echo "wp-saml-auth.ci-${CIRCLE_BUILD_NUM}" > "/tmp/site_env_${{ matrix.simplesamlphp_version }}.txt"

      - name: Upload cleanup artifact (per-version)
        uses: actions/upload-artifact@v4
        with:
          name: site-env-${{ matrix.simplesamlphp_version }}
          path: /tmp/site_env_${{ matrix.simplesamlphp_version }}.txt
          if-no-files-found: error
          retention-days: 3

      - name: Validate fixture version
        run: ./bin/validate-fixture-version.sh

      - name: Prepare and run Behat tests
        run: |
          set -euo pipefail
          echo ""
          echo "=========================================================================="
          echo "Running Behat on https://${TERMINUS_ENV}-${TERMINUS_SITE}.pantheonsite.io/wp-login.php"
          echo "with SimpleSAMLphp version $SIMPLESAMLPHP_VERSION"
          echo "=========================================================================="
          echo ""

          # Prepare fixture environment for tests.
          if [ "${{ matrix.simplesamlphp_version }}" != "1.18.0" ]; then
            ./bin/behat-prepare.sh
          else
            ./bin/1.18/behat-prepare-simplesaml1.18.0.sh
          fi

          ./bin/behat-test.sh --strict

  # ==============================
  # Cleanup after all Behat jobs
  # ==============================
  behat-cleanup:
    if: ${{ github.event_name != 'schedule' || github.ref_name == 'master' }}
    name: Behat cleanup
    runs-on: ubuntu-latest
    needs:
      - behat

    container:
      image: quay.io/pantheon-public/build-tools-ci:8.x-php8.2
      options: --user root

    env:
      TERMINUS_SITE: wp-saml-auth
      CIRCLE_BUILD_NUM: ${{ github.run_number }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      TERMINUS_TOKEN: ${{ secrets.TERMINUS_TOKEN }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set environment variables (cleanup)
        run: |
          {
            echo "export TERMINUS_ENV=ci-${CIRCLE_BUILD_NUM}"
            echo "export SITE_ENV=wp-saml-auth.ci-${CIRCLE_BUILD_NUM}"
          } >> $GITHUB_ENV

      - name: Download all site-env artifacts
        uses: actions/download-artifact@v4
        with:
          path: /tmp/behat-envs
          pattern: site-env-*
          merge-multiple: true

      - name: Terminus auth (optional)
        run: |
          if [ -z "${TERMINUS_TOKEN:-}" ]; then
            echo "TERMINUS_TOKEN missing; assuming unauthenticated build"
            exit 0
          fi
          terminus auth:login --machine-token="$TERMINUS_TOKEN"

      - name: Run Cleanup Script
        run: ./bin/behat-cleanup.sh

  # ==============================
  # PHPUnit (matrix: PHP versions)
  # ==============================
  phpunit:
    if: ${{ github.event_name != 'schedule' || github.ref_name == 'master' }}
    name: Test with PHP ${{ matrix.php_version }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        php_version: ["7.4", "8.0", "8.1", "8.2"]

    services:
      mariadb:
        image: mariadb:10.4
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: wordpress
          MARIADB_ROOT_HOST: '%'
        ports: [ "3306:3306" ]
        options: >-
          --health-cmd="mysqladmin ping -h 127.0.0.1 -proot"
          --health-interval=10s --health-timeout=5s --health-retries=10

    env:
      WP_TESTS_DIR: /tmp/wordpress-tests-lib
      WP_CORE_DIR: /tmp/wordpress/
      DB_HOST: 127.0.0.1
      DB_USER: root
      DB_PASSWORD: root
      DB_PASS: root
      DB_NAME: wordpress_test
      MYSQL_PWD: root

    steps:
      - uses: actions/checkout@v4

      - uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php_version }}
          extensions: imagick, mysqli
          tools: pecl, wp
          coverage: none

      - name: System deps
        run: |
          sudo apt-get update
          sudo apt-get install -y subversion libmagickwand-dev mariadb-client

      - name: Configure MySQL client defaults
        run: |
          cat > "$HOME/.my.cnf" <<'EOF'
          [client]
          user=root
          password=root
          host=127.0.0.1
          protocol=tcp
          EOF
          chmod 600 "$HOME/.my.cnf"

      - name: Wait for MariaDB
        run: |
          for i in {1..30}; do
            if mysqladmin ping --silent; then echo "MariaDB is up"; break; fi
            echo "Waiting for MariaDB..."; sleep 2
          done

      - name: Create test database
        run: |
          mysqladmin ping
          mysql -e "CREATE DATABASE IF NOT EXISTS \`${DB_NAME}\`;"
          mysql -e "SHOW DATABASES LIKE '${DB_NAME}';"

      - name: Seed wp-cli config (non-interactive + creds)
        run: |
          cat > /tmp/wp-cli.yml <<EOF
          path: /tmp/wordpress
          core download:
            version: latest
            locale: en_US
            force: true
          config create:
            dbname: ${DB_NAME}
            dbuser: ${DB_USER}
            dbpass: ${DB_PASS}
            dbhost: ${DB_HOST}
            skip-check: true
          EOF
          echo "WP_CLI_CONFIG_PATH=/tmp/wp-cli.yml" >> "$GITHUB_ENV"

      # cache should be per-PHP so vendors don't bleed across versions
      - name: Cache Composer deps
        uses: actions/cache@v4
        with:
          path: |
            vendor
            ~/.composer/cache
          key: php-${{ matrix.php_version }}-composer-${{ hashFiles('composer.json') }}
          restore-keys: |
            php-${{ matrix.php_version }}-composer-

      # For PHP 7.4/8.0: resolve for this platform
      - name: Resolve Composer deps (update for this PHP)
        if: matrix.php_version == '7.4' || matrix.php_version == '8.0'
        run: |
          composer update -n --prefer-dist --no-progress --with-all-dependencies
          chmod +x bin/*.sh

      # For PHP 8.1/8.2: install from lock is fine
      - name: Install Composer deps (use lock)
        if: matrix.php_version != '7.4' && matrix.php_version != '8.0'
        run: |
          composer install -n --prefer-dist --no-progress
          chmod +x bin/*.sh

      - name: Install Composer deps
        run: |
          composer install -n --prefer-dist
          chmod +x bin/*.sh

      - name: Run PHPUnit (idempotent; fix configs; ensure tests)
        run: |
          set -euo pipefail

          rm -rf /tmp/wordpress /tmp/wordpress-tests-lib || true
          mkdir -p /tmp/wordpress /tmp/wordpress-tests-lib
          
          # Choose installer path based on DB presence
          if mysql -e "USE \`${DB_NAME}\`;" >/dev/null 2>&1; then
            echo "DB ${DB_NAME} exists → using composer test:install (skip DB)"
            INSTALL_CMD="composer test:install"
          else
            echo "DB ${DB_NAME} missing → using composer test:install:withdb"
            INSTALL_CMD="composer test:install:withdb"
          fi

          # Try once; don't fail the job yet (we'll self-heal below)
          timeout 8m ${INSTALL_CMD} || true

          # Ensure WP core is present
          if [ ! -f /tmp/wordpress/wp-includes/version.php ]; then
            echo "WordPress core not found; downloading…"
            wp core download --path=/tmp/wordpress --version=latest --locale=en_US --force
          fi

          # FORCE correct DB constants into wp-config.php (the installer may have written empty DB_PASSWORD)
          if [ -f /tmp/wordpress/wp-config.php ]; then
            wp --path=/tmp/wordpress config set DB_NAME      "${DB_NAME}"                             --type=constant --raw || true
            wp --path=/tmp/wordpress config set DB_USER      "${DB_USER}"                             --type=constant --raw || true
            wp --path=/tmp/wordpress config set DB_PASSWORD  "${DB_PASS:-${DB_PASSWORD:-}}"           --type=constant --raw || true
            wp --path=/tmp/wordpress config set DB_HOST      "${DB_HOST}"                             --type=constant --raw || true
          else
            # create one if it wasn't created
            wp config create --path=/tmp/wordpress \
              --dbname="${DB_NAME}" --dbuser="${DB_USER}" --dbpass="${DB_PASS:-${DB_PASSWORD:-}}" --dbhost="${DB_HOST}" \
              --skip-check --force
          fi

          # Sanity: must be able to connect now
          wp --path=/tmp/wordpress db check

          # Ensure the WordPress test suite is present (includes/ + data/)
          if [ ! -f /tmp/wordpress-tests-lib/includes/functions.php ]; then
            WPV="$(wp core version --path=/tmp/wordpress 2>/dev/null || echo trunk)"
            echo "Fetching WordPress test suite (${WPV}) into /tmp/wordpress-tests-lib…"
            BASE="https://develop.svn.wordpress.org"
            TAG_PATH="${BASE}/tags/${WPV}"
            if svn ls "${TAG_PATH}/" >/dev/null 2>&1; then
              SRC="${TAG_PATH}"
            else
              echo "Tag ${WPV} not found; using trunk tests"
              SRC="${BASE}/trunk"
            fi
            svn co --quiet "${SRC}/tests/phpunit/includes/" "/tmp/wordpress-tests-lib/includes"
            svn co --quiet "${SRC}/tests/phpunit/data/"     "/tmp/wordpress-tests-lib/data"
          fi

          # Ensure wp-tests-config.php exists and points to /tmp/wordpress
          if [ ! -f /tmp/wordpress-tests-lib/wp-tests-config.php ]; then
            cat > /tmp/wordpress-tests-lib/wp-tests-config.php <<PHP
          <?php
          define( 'DB_NAME', '${DB_NAME}' );
          define( 'DB_USER', '${DB_USER}' );
          define( 'DB_PASSWORD', '${DB_PASS:-${DB_PASSWORD:-}}' );
          define( 'DB_HOST', '${DB_HOST}' );
          define( 'DB_CHARSET', 'utf8' );
          define( 'DB_COLLATE', '' );
          \$table_prefix = 'wptests_';

          define( 'WP_DEBUG', true );
          define( 'WP_TESTS_DOMAIN', 'example.org' );
          define( 'WP_TESTS_EMAIL', 'admin@example.org' );
          define( 'WP_TESTS_TITLE', 'Test Blog' );
          define( 'WP_PHP_BINARY', 'php' );
          define( 'WPLANG', '' );

          // Point tests at the downloaded WP core
          define( 'ABSPATH', '/tmp/wordpress/' );
          PHP
          fi

          # Run tests
          composer phpunit
