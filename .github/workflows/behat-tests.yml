name: Behat and phpunit

on:
  push:
  pull_request:

jobs:
  lint-and-tests:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Use PHP matrix
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php }}
          tools: composer, wp-cli
          coverage: none
        if: ${{ matrix.php != '' }} # keep your real matrix

      - name: Install Terminus
        uses: pantheon-systems/terminus-github-actions@v1
        with:
          pantheon-machine-token: ${{ secrets.TERMINUS_TOKEN }}

      # Load SSH key so `terminus wp <site.env> -- ...` can SSH to appserver
      # Option A: use stored private key
      - name: Load SSH key for Pantheon appserver
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.PANTHEON_SSH_PRIVATE_KEY }}

      # Option B (ephemeral key) — use this instead of the step above if preferred:
      # - name: Create ephemeral SSH key and add to Pantheon
      #   run: |
      #     mkdir -p ~/.ssh && chmod 700 ~/.ssh
      #     ssh-keygen -t ed25519 -N "" -f ~/.ssh/id_ed25519
      #     eval "$(ssh-agent -s)"
      #     ssh-add ~/.ssh/id_ed25519
      #     terminus auth:ssh-key:add ~/.ssh/id_ed25519.pub --yes

      - name: Install dependencies
        run: composer install --no-progress --prefer-dist

      - name: ShellCheck
        run: shellcheck -x bin/*.sh

      # PHPUnit bootstrap (prepares WP tests & the SimpleSAMLphp mock)
      - name: PHPUnit bootstrap
        run: bin/phpunit-bootstrap.sh
        env:
          DB_HOST: 127.0.0.1
          DB_USER: root
          DB_PASSWORD: root
          DB_NAME: ${{ matrix.db_name }}
          WP_TESTS_DIR: /tmp/wordpress-tests-lib
          WP_CORE_DIR: /tmp/wordpress/

      # Actual PHPUnit run
      - name: PHPUnit
        run: |
          if [ -x vendor/bin/phpunit ]; then vendor/bin/phpunit; else phpunit; fi

  behat:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Install Terminus
        uses: pantheon-systems/terminus-github-actions@v1
        with:
          pantheon-machine-token: ${{ secrets.TERMINUS_TOKEN }}

      - name: Load SSH key for Pantheon appserver
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.PANTHEON_SSH_PRIVATE_KEY }}

      - name: Behat prepare
        run: bin/behat-prepare.sh
        env:
          TERMINUS_SITE: wp-saml-auth
          TERMINUS_ENV: ${{ steps.compute_env.outputs.env }} # or however you set it
          SIMPLESAMLPHP_VERSION: 2.4.0
          WORDPRESS_ADMIN_USERNAME: pantheon
          WORDPRESS_ADMIN_EMAIL: no-reply@getpantheon.com
          WORDPRESS_ADMIN_PASSWORD: pantheon
          WP_TESTS_DIR: /tmp/wordpress-tests-lib
          WP_CORE_DIR: /tmp/wordpress/

      # … your behat run + cleanup
