name: Behat & PHPUnit

on:
  pull_request:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * *" # nightly

defaults:
  run:
    shell: bash

permissions:
  contents: read
  actions: write

# ======================================================================================
# JOBS
# ======================================================================================
jobs:
  ##
  ## Behat E2E Tests (Matrix: SimpleSAMLphp versions)
  ##
  behat:
    if: ${{ github.event_name != 'schedule' || github.ref_name == 'master' }}
    name: Behat (SimpleSAMLphp ${{ matrix.simplesamlphp_version }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        simplesamlphp_version: ["1.18.0", "2.0.0", "2.4.0"]

    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      TERMINUS_TOKEN: ${{ secrets.TERMINUS_TOKEN }}
      TERMINUS_SITE: wp-saml-auth
      CIRCLE_BUILD_NUM: ${{ github.run_number }} # For script compatibility

    steps:
      - &checkout # Anchor defined here
        name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - &cache-composer # Anchor defined here
        name: Cache Composer vendor directory
        uses: actions/cache@v4
        with:
          path: vendor
          key: composer-cache-v1-${{ hashFiles('composer.lock') }}
          restore-keys: |
            composer-cache-v1-

      - name: Make scripts executable
        run: chmod +x ./bin/ci/*.sh

      - name: Set up Behat environment
        run: ./bin/ci/setup-behat-env.sh ${{ matrix.simplesamlphp_version }}

      - name: Force SSH to ignore host keys
        run: echo "GIT_SSH_COMMAND=ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null" >> $GITHUB_ENV

      - name: Install SSH key
        uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.SITE_OWNER_SSH_PRIVATE_KEY }}

      - name: Configure Composer for GitHub OAuth
        if: env.GITHUB_TOKEN
        run: composer config -g github-oauth.github.com "$GITHUB_TOKEN"

      - &install-terminus # Anchor defined here
        name: Install Terminus
        uses: pantheon-systems/terminus-github-actions@v1
        with:
          pantheon-machine-token: ${{ secrets.TERMINUS_TOKEN }}

      - name: Upload environment name for cleanup
        uses: actions/upload-artifact@v4
        with:
          name: site-env-${{ matrix.simplesamlphp_version }}
          path: /tmp/site_env.txt
          if-no-files-found: error
          retention-days: 3

      - name: Validate plugin version
        uses: jazzsequence/action-validate-plugin-version@v1
        with:
          branch: ${{ github.head_ref }}
          dry-run: 'true'

      - name: Prepare and run Behat tests
        run: ./bin/ci/run-behat-tests.sh ${{ matrix.simplesamlphp_version }}

  ##
  ## Behat Cleanup (Always runs)
  ##
  behat-cleanup:
    if: always()
    needs: [behat]
    name: Behat Cleanup
    runs-on: ubuntu-latest
    concurrency:
      group: behat-cleanup-lock
      cancel-in-progress: false

    env:
      TERMINUS_SITE: wp-saml-auth
      TERMINUS_TOKEN: ${{ secrets.TERMINUS_TOKEN }}

    steps:
      - *checkout # Alias used here

      - name: Download all environment artifacts
        uses: actions/download-artifact@v4
        with:
          path: /tmp/behat-envs
          pattern: site-env-*
          merge-multiple: true

      - *install-terminus # Alias used here

      - name: Run cleanup script
        run: ./bin/behat-cleanup.sh # This was already a script, which is good practice

  ##
  ## PHPUnit Tests (Matrix: PHP versions)
  ##
  phpunit:
    if: ${{ github.event_name != 'schedule' || github.ref_name == 'master' }}
    name: PHPUnit (PHP ${{ matrix.php_version }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        php_version: ["7.4", "8.0", "8.1", "8.2"]

    services:
      mariadb:
        image: mariadb:10.4
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: wordpress
        ports: ["3306:3306"]
        options: >-
          --health-cmd="mysqladmin ping -h 127.0.0.1 -proot"
          --health-interval=10s --health-timeout=5s --health-retries=10

    env:
      WP_TESTS_DIR: /tmp/wordpress-tests-lib
      WP_CORE_DIR: /tmp/wordpress/
      DB_HOST: 127.0.0.1
      DB_USER: root
      DB_PASSWORD: root
      DB_NAME: wordpress_test

    steps:
      - *checkout # Alias used here

      - name: Setup PHP ${{ matrix.php_version }}
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php_version }}
          extensions: imagick, mysqli
          tools: pecl, wp
          coverage: none

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y subversion libmagickwand-dev mariadb-client

      - name: Make scripts executable
        run: chmod +x ./bin/ci/*.sh

      - name: Wait for MariaDB to be ready
        run: ./bin/ci/wait-for-db.sh

      - name: Create test database
        run: mysql -h 127.0.0.1 -u root -proot -e "CREATE DATABASE IF NOT EXISTS \`${DB_NAME}\`;"

      - name: Cache Composer dependencies
        uses: actions/cache@v4
        with:
          path: |
            vendor
            ~/.composer/cache
          key: php-${{ matrix.php_version }}-composer-${{ hashFiles('composer.json') }}
          restore-keys: |
            php-${{ matrix.php_version }}-composer-

      - name: Install Composer dependencies
        run: |
          # Older PHP versions require an update to resolve compatible dependency versions.
          if [[ "${{ matrix.php_version }}" == "7.4" || "${{ matrix.php_version }}" == "8.0" ]]; then
            composer update --prefer-dist --no-progress --with-all-dependencies
          else
            composer install --prefer-dist --no-progress
          fi

      - name: Prepare environment and run PHPUnit tests
        run: ./bin/ci/run-phpunit-tests.sh
