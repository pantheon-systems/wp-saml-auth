name: Behat and PHPUnit

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ "**" ]

jobs:
  phpunit:
    name: PHPUnit (PHP ${{ matrix.php }})
    runs-on: ubuntu-24.04
    timeout-minutes: 30
    continue-on-error: ${{ matrix.experimental == true }}
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: wp_test
        ports: [ "3306:3306" ]
        options: >-
          --health-cmd="mysqladmin ping -h 127.0.0.1 -proot"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=10

    strategy:
      fail-fast: false
      matrix:
        php: [ '7.4', '8.0', '8.1', '8.2', '8.3', '8.4' ]
        include:
          - php: '8.4'
            experimental: true

    env:
      COMPOSER_PROCESS_TIMEOUT: 0
      COMPOSER_NO_INTERACTION: 1
      COMPOSER_NO_AUDIT: 1
      DB_HOST: 127.0.0.1
      DB_USER: root
      DB_PASSWORD: root
      DB_NAME: wp_test_${{ matrix.php }}
      WP_TESTS_DIR: /tmp/wordpress-tests-lib
      WP_CORE_DIR: /tmp/wordpress/

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Setup PHP ${{ matrix.php }}
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php }}
          tools: composer:v2
          coverage: none
          extensions: mysqli

      - name: Cache Composer
        uses: actions/cache@v4
        with:
          path: |
            vendor
            ~/.composer/cache
          key: composer-${{ runner.os }}-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            composer-${{ runner.os }}-

      - name: Install Composer dependencies (incl. yoast/phpunit-polyfills)
        run: |
          composer install --no-progress --no-interaction
          if ! [ -d vendor/yoast/phpunit-polyfills ]; then
            composer require --no-progress --no-interaction --dev yoast/phpunit-polyfills:^2
          fi

      - name: Make CI scripts executable
        run: chmod +x bin/phpunit-bootstrap.sh || true

      - name: Bootstrap WP test environment
        run: bin/phpunit-bootstrap.sh

      - name: Run PHPUnit
        env:
          XDEBUG_MODE: off
        run: |
          if [ -x vendor/bin/phpunit ]; then
            vendor/bin/phpunit
          else
            PHPV=$(php -r 'echo PHP_MAJOR_VERSION.".".PHP_MINOR_VERSION;')
            if [ "$PHPV" = "8.4" ]; then
              curl -fsSL https://phar.phpunit.de/phpunit-10.phar -o phpunit.phar
            else
              curl -fsSL https://phar.phpunit.de/phpunit-9.phar -o phpunit.phar
            fi
            php ./phpunit.phar
          fi

  behat:
    name: Behat (SSP ${{ matrix.ssp }})
    runs-on: ubuntu-24.04
    timeout-minutes: 45
    strategy:
      fail-fast: false
      matrix:
        ssp: [ '1.18.0', '2.0.0', '2.4.0' ]

    env:
      COMPOSER_PROCESS_TIMEOUT: 0
      COMPOSER_NO_INTERACTION: 1
      COMPOSER_NO_AUDIT: 1
      # required secrets:
      #   TERMINUS_TOKEN (Pantheon machine token)
      #   PANTHEON_SITE  (Pantheon site machine name)
      #   PANTHEON_SSH_PRIVATE_KEY (SSH key that has access to the site; add to Pantheon Dashboard)
      TERMINUS_SITE: ${{ secrets.PANTHEON_SITE }}
      TERMINUS_ENV: ci${{ matrix.ssp && replace(matrix.ssp, '.', '') }}${{ github.run_number }}${{ github.run_attempt }}
      WORDPRESS_ADMIN_USERNAME: pantheon
      WORDPRESS_ADMIN_EMAIL: no-reply@getpantheon.com
      WORDPRESS_ADMIN_PASSWORD: pantheon
      WP_TESTS_DIR: /tmp/wordpress-tests-lib
      WP_CORE_DIR: /tmp/wordpress/
      SIMPLESAMLPHP_VERSION: ${{ matrix.ssp }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Setup PHP (for Behat tooling)
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          coverage: none
          tools: composer:v2

      - name: Cache Composer
        uses: actions/cache@v4
        with:
          path: |
            vendor
            ~/.composer/cache
          key: composer-${{ runner.os }}-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            composer-${{ runner.os }}-

      - name: Install Composer dependencies
        run: composer install --no-progress --no-interaction

      - name: Install Terminus (official action)
        uses: pantheon-systems/terminus-github-actions@v1
        with:
          pantheon-machine-token: ${{ secrets.TERMINUS_TOKEN }}

      - name: Start ssh-agent and add key (required for SFTP upload)
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.PANTHEON_SSH_PRIVATE_KEY }}

      - name: Make CI scripts executable
        run: chmod +x bin/behat-prepare.sh || true

      - name: Prepare Pantheon multidev + MU plugin
        env:
          PANTHEON_SITE: ${{ secrets.PANTHEON_SITE }}
          TERMINUS_ENV: ${{ env.TERMINUS_ENV }}
          SIMPLESAMLPHP_VERSION: ${{ matrix.ssp }}
        run: bin/behat-prepare.sh

      - name: Run Behat suite
        env:
          XDEBUG_MODE: off
        run: vendor/bin/behat --colors --no-interaction
