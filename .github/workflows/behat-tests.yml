name: Behat & PHPUnit

on:
  pull_request:
  schedule:
    - cron: '0 0 * * *'

permissions:
  contents: read
  actions: read

jobs:
  # =======================
  # PHPUnit
  # =======================
  test-phpunit:
    if: github.event_name != 'schedule'
    name: "PHPUnit - PHP ${{ matrix.php_version }}"
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        include:
          - php_version: '7.4'
            composer_flags: '--no-dev'
            phpunit_bin: 'phpunit'                # from setup-php
          - php_version: '8.1'
            composer_flags: ''
            phpunit_bin: 'vendor/bin/phpunit'
          - php_version: '8.2'
            composer_flags: ''
            phpunit_bin: 'vendor/bin/phpunit'
          - php_version: '8.3'
            composer_flags: ''
            phpunit_bin: 'vendor/bin/phpunit'
          - php_version: '8.4'
            composer_flags: ''
            phpunit_bin: 'vendor/bin/phpunit'

    services:
      mariadb:
        image: mariadb:10.4
        env:
          MYSQL_ROOT_PASSWORD: root
        ports: [ "3306:3306" ]
        options: >-
          --health-cmd="mysqladmin ping -h 127.0.0.1 -proot"
          --health-interval=10s --health-timeout=5s --health-retries=10

    env:
      WP_TESTS_DIR: /tmp/wordpress-tests-lib
      WP_CORE_DIR: /tmp/wordpress/
      DB_HOST: 127.0.0.1
      DB_USER: root
      DB_PASSWORD: root
      DB_NAME: wordpress_test
      COMPOSER_PROCESS_TIMEOUT: 0
      COMPOSER_NO_INTERACTION: 1
      COMPOSER_NO_AUDIT: 1

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with: { fetch-depth: 0 }

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php_version }}
          extensions: imagick, mysqli
          tools: wp-cli, phpunit:^9.6

      - name: Cache Composer (project)
        uses: actions/cache@v4
        with:
          path: |
            vendor
            ~/.composer/cache
          key: php-${{ matrix.php_version }}-composer-${{ hashFiles('composer.lock', 'composer.json') }}
          restore-keys: |
            php-${{ matrix.php_version }}-composer-

      - name: Install system deps
        run: sudo apt-get update && sudo apt-get install -y subversion mariadb-client dos2unix curl

      # -------- Critical: guaranteed SimpleSAML mock for ALL PHP children (PHP 8.x too)
      - name: Write SimpleSAML mock and prepend it
        run: |
          set -euxo pipefail
          MOCK=/tmp/ssp-mock.php
          cat > "$MOCK" <<'PHP'
          <?php
          namespace SimpleSAML\Auth {
            class Simple {
              public function isAuthenticated(){ return true; }
              public function requireAuth(array $params = []){ return true; }
              public function logout($returnTo = null){ return true; }
              public function login($returnTo = null, array $params = [], $force = false){ return true; }
              public function getAttributes(){
                return [
                  'uid'          => ['ci-user'],
                  'email'        => ['user@example.com'],
                  'mail'         => ['user@example.com'],
                  'display_name' => ['CI User'],
                  'first_name'   => ['CI'],
                  'last_name'    => ['User'],
                ];
              }
            }
          }
          namespace {
            // Legacy alias for older references, if any.
            if (!class_exists('SimpleSAML_Auth_Simple') && class_exists('\SimpleSAML\Auth\Simple')) {
              class SimpleSAML_Auth_Simple extends \SimpleSAML\Auth\Simple {}
            }
          }
          PHP
          echo "WP_PHP_BINARY=\"$(command -v php) -d auto_prepend_file=$MOCK\"" >> $GITHUB_ENV
          php -r "require '$MOCK'; echo (class_exists('\SimpleSAML\Auth\Simple')?'OK':'FAIL'),\"\n\";"

      - name: Install Composer deps
        run: composer install --prefer-dist --no-progress ${{ matrix.composer_flags }}

      - name: Set Script Permissions
        run: |
          if [ -d ./bin ]; then
            find ./bin -type f -name "*.sh" -exec dos2unix {} \; -exec chmod +x {} \;
          fi

      # -------- Portable WP test-suite installer (works without dev deps)
      - name: Install WordPress tests (portable)
        run: |
          set -euxo pipefail
          WP_VERSION="latest"
          CORE_DIR="${WP_CORE_DIR}"
          TESTS_DIR="${WP_TESTS_DIR}"

          mkdir -p "$CORE_DIR" "$TESTS_DIR"

          # 1) Download WordPress core
          curl -fsSL "https://wordpress.org/${WP_VERSION}.tar.gz" | tar -xzf - -C /tmp
          rsync -a /tmp/wordpress/ "$CORE_DIR/"

          # 2) Fetch tests library from develop.svn (stable includes + data)
          svn export --quiet https://develop.svn.wordpress.org/trunk/tests/phpunit/includes/ "$TESTS_DIR/includes"
          svn export --quiet https://develop.svn.wordpress.org/trunk/tests/phpunit/data/     "$TESTS_DIR/data"

          # 3) Create wp-tests-config.php
          cat > "$TESTS_DIR/wp-tests-config.php" <<CFG
          <?php
          define( 'ABSPATH', '${CORE_DIR}/' );
          define( 'DB_NAME', '${DB_NAME}' );
          define( 'DB_USER', '${DB_USER}' );
          define( 'DB_PASSWORD', '${DB_PASSWORD}' );
          define( 'DB_HOST', '${DB_HOST}' );
          define( 'WP_DEBUG', true );
          \$table_prefix = 'wptests_';
          CFG

          # 4) Create DB
          mysql -h "${DB_HOST}" -u"${DB_USER}" -p"${DB_PASSWORD}" -e "CREATE DATABASE IF NOT EXISTS \`${DB_NAME}\` CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;"

      - name: (Optional) Install SimpleSAMLphp tree for unit tests
        run: |
          set -euxo pipefail
          INSTALL_DIR="${WP_TESTS_DIR}/plugins/simplesamlphp"
          mkdir -p "${INSTALL_DIR}"
          curl -fsSL "https://github.com/simplesamlphp/simplesamlphp/releases/download/v2.4.0/simplesamlphp-2.4.0-full.tar.gz" \
            | tar -zxf - --strip-components=1 -C "${INSTALL_DIR}"
          mkdir -p "${INSTALL_DIR}/config"
          : > "${INSTALL_DIR}/config/config.php"

      - name: Run PHPUnit
        run: ${{ matrix.phpunit_bin }}

  # =======================
  # Behat (Pantheon)
  # =======================
  test-behat:
    name: "Behat - SimpleSAMLphp ${{ matrix.simplesamlphp_version }}"
    runs-on: ubuntu-latest
    if: github.event_name != 'schedule' || (github.event_name == 'schedule' && github.ref == 'refs/heads/master')

    strategy:
      fail-fast: false
      matrix:
        simplesamlphp_version: ["1.18.0", "2.0.0", "2.4.0"]

    env:
      WP_TESTS_DIR: /tmp/wordpress-tests-lib
      WP_CORE_DIR: /tmp/wordpress/

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with: { fetch-depth: 0 }

      - name: Install Terminus
        uses: pantheon-systems/terminus-github-actions@v1
        with:
          pantheon-machine-token: ${{ secrets.TERMINUS_TOKEN }}

      - name: Cache Composer (project)
        uses: actions/cache@v4
        with:
          path: vendor
          key: ${{ runner.os }}-behat-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-behat-composer-

      - name: Install Composer deps
        run: composer install -n --prefer-dist

      # Matrix-aware SimpleSAMLphp install:
      #  - 1.18.0 => plain tar (NO composer)
      #  - 2.0.0  => plain tar + composer install --no-dev  (no "-full" available)
      #  - 2.4.0  => "-full" tar (vendor included)
      - name: Install SimpleSAMLphp
        env:
          SIMPLESAMLPHP_VERSION: ${{ matrix.simplesamlphp_version }}
        run: |
          set -euxo pipefail
          INSTALL_DIR="${WP_TESTS_DIR}/simplesamlphp"
          mkdir -p "${INSTALL_DIR}"

          if [ "${SIMPLESAMLPHP_VERSION}" = "1.18.0" ]; then
            URL="https://github.com/simplesamlphp/simplesamlphp/releases/download/v1.18.0/simplesamlphp-1.18.0.tar.gz"
            curl -fsSL "$URL" | tar -zxf - --strip-components=1 -C "${INSTALL_DIR}"
            test -f "${INSTALL_DIR}/lib/_autoload.php"
          elif [ "${SIMPLESAMLPHP_VERSION}" = "2.0.0" ]; then
            URL="https://github.com/simplesamlphp/simplesamlphp/releases/download/v2.0.0/simplesamlphp-2.0.0.tar.gz"
            curl -fsSL "$URL" | tar -zxf - --strip-components=1 -C "${INSTALL_DIR}"
            # vendor is NOT bundled for 2.0.0, install only runtime deps
            composer install --no-dev --working-dir="${INSTALL_DIR}"
          else
            URL="https://github.com/simplesamlphp/simplesamlphp/releases/download/v${SIMPLESAMLPHP_VERSION}/simplesamlphp-${SIMPLESAMLPHP_VERSION}-full.tar.gz"
            curl -fsSL "$URL" | tar -zxf - --strip-components=1 -C "${INSTALL_DIR}"
          fi

          mkdir -p "${INSTALL_DIR}/config"
          : > "${INSTALL_DIR}/config/config.php"

      - name: Configure SSH (non-strict)
        run: |
          mkdir -p ~/.ssh
          printf "Host *\n  StrictHostKeyChecking no\n" >> ~/.ssh/config

      - name: Configure Composer for GitHub Token
        if: env.GITHUB_TOKEN != ''
        env: { GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} }
        run: composer config -g github-oauth.github.com $GITHUB_TOKEN

      - name: Authenticate with Terminus
        if: env.TERMINUS_TOKEN != ''
        env: { TERMINUS_TOKEN: ${{ secrets.TERMINUS_TOKEN }} }
        run: terminus auth:login --machine-token=$TERMINUS_TOKEN

      - name: Compute unique Multidev env name (â‰¤11 chars)
        run: |
          set -euo pipefail
          case "${{ matrix.simplesamlphp_version }}" in
            1.18.0) SUF="a" ;; 2.0.0) SUF="b" ;; 2.4.0) SUF="c" ;; *) SUF="x" ;;
          esac
          H=$(printf '%s' "${GITHUB_RUN_ID}-${{ matrix.simplesamlphp_version }}-${GITHUB_JOB}-${GITHUB_RUN_ATTEMPT}" | sha1sum | cut -c1-7)
          NAME="ci${H}${SUF}"
          NAME="${NAME:0:11}"
          {
            echo "TERMINUS_SITE=wp-saml-auth"
            echo "TERMINUS_ENV=$NAME"
            echo "WORDPRESS_ADMIN_USERNAME=pantheon"
            echo "WORDPRESS_ADMIN_EMAIL=no-reply@getpantheon.com"
            echo "WORDPRESS_ADMIN_PASSWORD=$(openssl rand -hex 8)"
            echo "SIMPLESAMLPHP_VERSION=${{ matrix.simplesamlphp_version }}"
          } >> $GITHUB_ENV
          echo "wp-saml-auth.${NAME}" > site_env.txt

      - name: Create or reuse Multidev (race-safe, non-fatal if exists)
        env: { TERMINUS_TOKEN: ${{ secrets.TERMINUS_TOKEN }} }
        run: |
          set -euo pipefail
          terminus auth:login --machine-token="$TERMINUS_TOKEN"
          if terminus env:info "${TERMINUS_SITE}.${TERMINUS_ENV}" >/dev/null 2>&1; then
            echo "Reusing existing ${TERMINUS_ENV}"
          else
            terminus env:create "${TERMINUS_SITE}.dev" "${TERMINUS_ENV}" || \
              echo "env:create non-zero; will continue if env now exists"
            terminus env:info "${TERMINUS_SITE}.${TERMINUS_ENV}" >/dev/null
          fi

      - name: Upload environment name artifact
        uses: actions/upload-artifact@v4
        with:
          name: behat-env-${{ matrix.simplesamlphp_version }}
          path: site_env.txt

      - name: Validate fixture version
        uses: jazzsequence/action-validate-plugin-version@v1
        with:
          branch: ${{ github.head_ref }}
          dry-run: 'true'

      - name: Prepare and run Behat tests
        run: |
          set -e
          if [ "${{ matrix.simplesamlphp_version }}" != '1.18.0' ]; then
            bash ./bin/behat-prepare.sh
          else
            bash ./bin/1.18/behat-prepare-simplesaml1.18.0.sh
          fi
          echo
          echo "=========================================================================="
          echo "Running Behat on https://${TERMINUS_ENV}-${TERMINUS_SITE}.pantheonsite.io/wp-login.php"
          echo "with SimpleSAMLphp version $SIMPLESAMLPHP_VERSION"
          echo "=========================================================================="
          echo
          bash ./bin/behat-test.sh --strict

  # =======================
  # Cleanup (always)
  # =======================
  behat-cleanup:
    name: "Behat Cleanup"
    runs-on: ubuntu-latest
    needs: test-behat
    if: always() && (github.event_name != 'schedule' || (github.event_name == 'schedule' && github.ref == 'refs/heads/master'))

    env:
      TERMINUS_SITE: wp-saml-auth
      TERMINUS_TOKEN: ${{ secrets.TERMINUS_TOKEN }}
      TERMINUS_ENV: cleanup-${{ github.run_number }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with: { fetch-depth: 0 }

      - name: Download all environment name artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: behat-env-*
          path: /tmp/behat-envs
          merge-multiple: true

      - name: Install Terminus
        uses: pantheon-systems/terminus-github-actions@v1
        with:
          pantheon-machine-token: ${{ secrets.TERMINUS_TOKEN }}

      - name: Run Cleanup Script (robust)
        run: |
          set -euo pipefail
          echo "The following environments will be cleaned up (if any):"
          if compgen -G "/tmp/behat-envs/*.txt" > /dev/null; then
            cat /tmp/behat-envs/*.txt || true
          else
            echo "(none found)"
          fi
          bash ./bin/behat-cleanup.sh
