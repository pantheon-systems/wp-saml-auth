name: PHPUnit & Behat

on:
  pull_request:
  workflow_dispatch: {}

env:
  COMPOSER_NO_INTERACTION: "1"
  COMPOSER_NO_AUDIT: "1"
  COMPOSER_PROCESS_TIMEOUT: "0"

jobs:
  phpunit:
    name: PHPUnit (PHP ${{ matrix.php }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        php: ["7.4", "8.0", "8.1", "8.2", "8.3", "8.4"]

    services:
      mysql:
        image: mysql:8
        env:
          MYSQL_ROOT_PASSWORD: root
        ports: ["3306:3306"]
        options: >-
          --health-cmd="mysqladmin ping -h 127.0.0.1 -proot"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=10

    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          persist-credentials: false
          submodules: recursive
          lfs: false

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php }}
          coverage: none
          tools: composer:v2

      - name: Create test DB
        run: |
          mysql -h 127.0.0.1 -uroot -proot -e "CREATE DATABASE IF NOT EXISTS wp_test_${{ matrix.php//./ }};"

      # Keep your dependencies install separate from Behat locks to prevent 7.4 conflicts.
      - name: Install Composer deps (root)
        run: composer install --no-progress --no-interaction

      # Prepare WP Core + Tests library into stable paths
      - name: Bootstrap WP test suite
        env:
          DB_HOST: 127.0.0.1
          DB_USER: root
          DB_PASSWORD: root
          DB_NAME: wp_test_${{ matrix.php//./ }}
          WP_CORE_DIR: /tmp/wordpress/
          WP_TESTS_DIR: /tmp/wordpress-tests-lib
          WP_VERSION: 6.8.3
          WP_TESTS_PHPUNIT_POLYFILLS_PATH: /tmp/phpunit-deps
        run: |
          bash bin/phpunit-bootstrap.sh

      # Only for PHP â‰¥ 8.0 weâ€™ll use PHAR fallback if vendor/bin/phpunit is missing
      - name: Run PHPUnit
        env:
          DB_HOST: 127.0.0.1
          DB_USER: root
          DB_PASSWORD: root
          DB_NAME: wp_test_${{ matrix.php//./ }}
          WP_CORE_DIR: /tmp/wordpress/
          WP_TESTS_DIR: /tmp/wordpress-tests-lib
          WP_TESTS_PHPUNIT_POLYFILLS_PATH: /tmp/phpunit-deps
          XDEBUG_MODE: off
        run: |
          if [ -x vendor/bin/phpunit ]; then
            vendor/bin/phpunit
          else
            PHPV=$(php -r 'echo PHP_MAJOR_VERSION.".".PHP_MINOR_VERSION;')
            if [ "$PHPV" = "8.4" ]; then
              curl -fsSL https://phar.phpunit.de/phpunit-10.phar -o phpunit.phar
            else
              curl -fsSL https://phar.phpunit.de/phpunit-9.phar -o phpunit.phar
            fi
            php ./phpunit.phar
          fi

  behat:
    name: Behat (SSP ${{ matrix.ssp }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        ssp: ["1.18.0", "2.0.0", "2.4.0"]

    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          persist-credentials: false
          submodules: recursive
          lfs: false

      - name: Setup PHP 8.2
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.2"
          tools: composer:v2
          coverage: none

      # ðŸ” This is the bit you asked to restore: official Terminus Action.
      - name: Install Terminus
        uses: pantheon-systems/terminus-github-actions@v1
        with:
          pantheon-machine-token: ${{ secrets.TERMINUS_TOKEN }}

      # SSH for Pantheon git clone/push during prepare scripts
      - name: SSH agent (Pantheon)
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.PANTHEON_SSH_PRIVATE_KEY }}

      - name: Add Pantheon hosts to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -p 2222 drush.in >> ~/.ssh/known_hosts

      # Validate required secrets without using `if:` on secrets.*
      - name: Validate Pantheon secrets
        run: |
          MISS=0
          [ -z "${{ secrets.TERMINUS_SITE }}" ] && echo "::error::TERMINUS_SITE is missing" && MISS=1
          [ -z "${{ secrets.TERMINUS_TOKEN }}" ] && echo "::error::TERMINUS_TOKEN is missing" && MISS=1
          [ $MISS -ne 0 ] && exit 1 || exit 0

      # Compute env names and export for subsequent steps
      - name: Compute Pantheon env vars
        env:
          SSP: ${{ matrix.ssp }}
          TERMINUS_SITE: ${{ secrets.TERMINUS_SITE }}
        run: |
          set -e
          ssp_num="${SSP//./}"
          suffix=$(printf "%04d" $(( GITHUB_RUN_NUMBER % 10000 )) )
          env_id="ci${ssp_num}${suffix}"
          TERMINUS_ENV="${env_id:0:10}"
          echo "TERMINUS_SITE=$TERMINUS_SITE" >> $GITHUB_ENV
          echo "TERMINUS_ENV=$TERMINUS_ENV" >> $GITHUB_ENV
          echo "SIMPLESAMLPHP_VERSION=$SSP" >> $GITHUB_ENV
          echo "PANTHEON_SITE_URL=${TERMINUS_ENV}-${TERMINUS_SITE}.pantheonsite.io" >> $GITHUB_ENV
          echo "Using env: $TERMINUS_SITE.$TERMINUS_ENV -> https://${TERMINUS_ENV}-${TERMINUS_SITE}.pantheonsite.io"

      # Install project deps needed for Behat contexts
      - name: Install Composer deps
        run: composer install --no-progress --no-interaction

      # Prepare Pantheon env:
      # * SSP 1.18.0 uses your custom script in bin/1.18/
      # * SSP >= 2.x uses the generic prepare script.
      - name: Prepare Pantheon environment
        env:
          WORDPRESS_ADMIN_USERNAME: pantheon
          WORDPRESS_ADMIN_EMAIL: no-reply@getpantheon.com
          WORDPRESS_ADMIN_PASSWORD: pantheon
        run: |
          set -eux
          if [ "${{ matrix.ssp }}" = "1.18.0" ]; then
            bash bin/1.18/behat-prepare-1.18.sh
          else
            bash bin/behat-prepare.sh
          fi

      # Always use workflow:wait (build:* is gone)
      - name: Wait for Pantheon workflow
        run: |
          SITE_ENV="${TERMINUS_SITE}.${TERMINUS_ENV}"
          terminus workflow:wait "$SITE_ENV"

      - name: Run Behat
        env:
          PANTHEON_SITE_URL: ${{ env.PANTHEON_SITE_URL }}
          WORDPRESS_ADMIN_USERNAME: pantheon
          WORDPRESS_ADMIN_EMAIL: no-reply@getpantheon.com
          WORDPRESS_ADMIN_PASSWORD: pantheon
          XDEBUG_MODE: off
        run: |
          vendor/bin/behat --colors --no-interaction
