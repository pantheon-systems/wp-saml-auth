name: Behat Tests

on:
  workflow_dispatch:
  pull_request:

jobs:
  behat:
    name: Behat (SSP ${{ matrix.ssp }})
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        ssp: ['1.18.0', '2.0.0', '2.4.0']

    env:
      WP_TESTS_DIR: /tmp/wordpress-tests-lib
      WP_CORE_DIR: /tmp/wordpress/
      TERMINUS_RELEASE: 4.1.0
      TERMINUS_SITE: wp-saml-auth
      SIMPLESAMLPHP_VERSION: ${{ matrix.ssp }}
      WORDPRESS_ADMIN_USERNAME: pantheon
      WORDPRESS_ADMIN_EMAIL: no-reply@getpantheon.com
      WORDPRESS_ADMIN_PASSWORD: ${{ secrets.WORDPRESS_ADMIN_PASSWORD || 'pantheon' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Compute Multidev name
        id: envname
        run: |
          . bin/ci-common.sh
          ENV_NAME="$(compute_env_name '${{ matrix.ssp }}' '${{ github.sha }}')"
          echo "TERMINUS_ENV=${ENV_NAME}" >> "$GITHUB_ENV"
          echo "env=${ENV_NAME}" >> "$GITHUB_OUTPUT"
          echo "Using Multidev: ${ENV_NAME}"

      - name: Install Terminus
        uses: pantheon-systems/terminus-github-actions@v1
        with:
          pantheon-machine-token: ${{ secrets.TERMINUS_TOKEN }}

      - name: Install Composer deps (for Behat tooling)
        run: composer install --no-progress --prefer-dist

      - name: Prepare Multidev + SimpleSAMLphp
        run: bin/behat-prepare.sh

      - name: Behat run tests
        env:
          TERMINUS_ENV: ${{ steps.envname.outputs.env }}
        run: |
          echo
          echo "=========================================================================="
          echo "Running Behat on https://${TERMINUS_ENV}-${TERMINUS_SITE}.pantheonsite.io/wp-login.php"
          echo "with SimpleSAMLphp version ${SIMPLESAMLPHP_VERSION}"
          echo "=========================================================================="
          echo
          bash ./bin/behat-test.sh --strict

      # Always try to prune multidevs even on failure
      # (Your cleanup script already tolerates missing auth/env)
      # Use an explicit dependency so cleanup runs once per matrix leg.
      # If you prefer a single cleanup after matrix, move this to a separate job-needs.
      # For simplicity, keep it per-leg.
      - name: Cleanup Multidev(s)
        if: always()
        run: bin/behat-cleanup.sh
        env:
          TERMINUS_SITE: ${{ env.TERMINUS_SITE }}
          TERMINUS_ENV: ${{ env.TERMINUS_ENV }}
