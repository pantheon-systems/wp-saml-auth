name: Behat & PHPUnit

on:
  pull_request:
  schedule:
    - cron: '0 0 * * *'

permissions:
  contents: read
  actions: read

jobs:
  # PHPUnit job (skips on scheduled runs)
  test-phpunit:
    if: github.event_name != 'schedule'
    name: "PHPUnit - PHP ${{ matrix.php_version }}"
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        php_version: [ '7.4', '8.1', '8.2', '8.3', '8.4' ]

    services:
      mariadb:
        image: mariadb:10.4
        env:
          MYSQL_ROOT_PASSWORD: root
        ports: [ "3306:3306" ]
        options: >-
          --health-cmd="mysqladmin ping -h 127.0.0.1 -proot"
          --health-interval=10s --health-timeout=5s --health-retries=10

    env:
      WP_TESTS_DIR: /tmp/wordpress-tests-lib
      WP_CORE_DIR: /tmp/wordpress/
      DB_HOST: 127.0.0.1
      DB_USER: root
      DB_PASSWORD: root
      DB_NAME: wordpress_test
      COMPOSER_PROCESS_TIMEOUT: 0
      COMPOSER_NO_INTERACTION: 1
      COMPOSER_NO_AUDIT: 1

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Prepare bin scripts (permissions + line endings)
        run: |
          sudo apt-get update
          sudo apt-get install -y dos2unix
          if [ -d ./bin ]; then
            find ./bin -type f -name "*.sh" -print -exec dos2unix {} \; -exec chmod +x {} \;
          fi

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php_version }}
          extensions: imagick, mysqli
          tools: wp-cli

      - name: Cache Composer dependencies
        uses: actions/cache@v4
        with:
          path: |
            vendor
            ~/.composer/cache
          key: php-${{ matrix.php_version }}-composer-${{ hashFiles('composer.json') }}
          restore-keys: |
            php-${{ matrix.php_version }}-composer-

      - name: Install Composer dependencies
        run: |
          sudo apt-get install -y subversion mariadb-client
          composer install --prefer-dist --no-progress

      - name: Install SimpleSAMLphp
        env:
          SIMPLESAMLPHP_VERSION: '2.4.0'
        run: |
          set -euxo pipefail
          INSTALL_DIR="${WP_TESTS_DIR}/simplesamlphp"
          if [ "${SIMPLESAMLPHP_VERSION}" == '2.0.0' ]; then
            DOWNLOAD_URL="https://github.com/simplesamlphp/simplesamlphp/releases/download/v${SIMPLESAMLPHP_VERSION}/simplesamlphp-${SIMPLESAMLPHP_VERSION}.tar.gz"
          else
            DOWNLOAD_URL="https://github.com/simplesamlphp/simplesamlphp/releases/download/v${SIMPLESAMLPHP_VERSION}/simplesamlphp-${SIMPLESAMLPHP_VERSION}-full.tar.gz"
          fi
          wget -q -O simplesamlphp.tar.gz "${DOWNLOAD_URL}"
          mkdir -p "${INSTALL_DIR}"
          tar -zxf simplesamlphp.tar.gz --strip-components=1 -C "${INSTALL_DIR}"
          rm -f "${INSTALL_DIR}/composer.lock"
          composer install --no-dev --working-dir="${INSTALL_DIR}"
          mkdir -p "${INSTALL_DIR}/config"
          touch "${INSTALL_DIR}/config/config.php"

      - name: Install WordPress Test Suite
        env:
          WP_TESTS_DB_NAME: ${{ env.DB_NAME }}
          WP_TESTS_DB_USER: ${{ env.DB_USER }}
          WP_TESTS_DB_PASS: ${{ env.DB_PASSWORD }} # Use correct env var name
          WP_TESTS_DB_HOST: ${{ env.DB_HOST }}
        run: |
          set -euxo pipefail
          # Temporarily replace the project's LOCAL phpunit executable
          mv vendor/bin/phpunit vendor/bin/phpunit.real
          echo -e '#!/bin/bash\necho "Skipping phpunit execution during installation."\nexit 0' > vendor/bin/phpunit
          chmod +x vendor/bin/phpunit
          
          # Run the installer script without arguments; it will use the env vars
          bash bin/install-local-tests.sh
          
          # Restore the original phpunit executable
          rm vendor/bin/phpunit
          mv vendor/bin/phpunit.real vendor/bin/phpunit

      - name: Run PHPUnit
        run: vendor/bin/phpunit -c phpunit.xml.dist

  # Behat integration tests against Pantheon (runs on PRs and nightly on master)
  test-behat:
    name: "Behat - SimpleSAMLphp ${{ matrix.simplesamlphp_version }}"
    runs-on: ubuntu-latest
    # Only run scheduled jobs on the master branch.
    if: github.event_name != 'schedule' || (github.event_name == 'schedule' && github.ref == 'refs/heads/master')

    strategy:
      fail-fast: false
      matrix:
        simplesamlphp_version: ["1.18.0", "2.0.0", "2.4.0"]

    env:
      WP_TESTS_DIR: /tmp/wordpress-tests-lib
      WP_CORE_DIR: /tmp/wordpress/

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Install Terminus
        uses: pantheon-systems/terminus-github-actions@v1
        with:
          pantheon-machine-token: ${{ secrets.TERMINUS_TOKEN }}

      - name: Cache Composer dependencies
        uses: actions/cache@v4
        with:
          path: vendor
          key: ${{ runner.os }}-behat-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-behat-composer-

      - name: Install Composer dependencies
        run: composer install -n --prefer-dist

      - name: Install SimpleSAMLphp
        env:
          SIMPLESAMLPHP_VERSION: ${{ matrix.simplesamlphp_version }}
        run: |
          set -euxo pipefail
          INSTALL_DIR="${WP_TESTS_DIR}/simplesamlphp"
          if [ "${SIMPLESAMLPHP_VERSION}" == '2.0.0' ]; then
            DOWNLOAD_URL="https://github.com/simplesamlphp/simplesamlphp/releases/download/v${SIMPLESAMLPHP_VERSION}/simplesamlphp-${SIMPLESAMLPHP_VERSION}.tar.gz"
          else
            DOWNLOAD_URL="https://github.com/simplesamlphp/simplesamlphp/releases/download/v${SIMPLESAMLPHP_VERSION}/simplesamlphp-${SIMPLESAMLPHP_VERSION}-full.tar.gz"
          fi
          wget -q -O simplesamlphp.tar.gz "${DOWNLOAD_URL}"
          mkdir -p "${INSTALL_DIR}"
          tar -zxf simplesamlphp.tar.gz --strip-components=1 -C "${INSTALL_DIR}"
          rm -f "${INSTALL_DIR}/composer.lock"
          composer install --no-dev --working-dir="${INSTALL_DIR}"
          mkdir -p "${INSTALL_DIR}/config"
          touch "${INSTALL_DIR}/config/config.php"

      - name: Set environment variables
        run: |
          echo "TERMINUS_SITE=wp-saml-auth" >> $GITHUB_ENV
          echo "TERMINUS_ENV=ci-${{ github.run_id }}" >> $GITHUB_ENV
          echo "WORDPRESS_ADMIN_USERNAME=pantheon" >> $GITHUB_ENV
          echo "WORDPRESS_ADMIN_EMAIL=no-reply@getpantheon.com" >> $GITHUB_ENV
          echo "WORDPRESS_ADMIN_PASSWORD=$(openssl rand -hex 8)" >> $GITHUB_ENV
          echo "SIMPLESAMLPHP_VERSION=${{ matrix.simplesamlphp_version }}" >> $GITHUB_ENV

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "StrictHostKeyChecking no" >> ~/.ssh/config

      - name: Configure Composer for GitHub Token
        if: env.GITHUB_TOKEN != ''
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: composer config -g github-oauth.github.com $GITHUB_TOKEN

      - name: Authenticate with Terminus
        if: env.TERMINUS_TOKEN != ''
        env:
          TERMINUS_TOKEN: ${{ secrets.TERMINUS_TOKEN }}
        run: terminus auth:login --machine-token=$TERMINUS_TOKEN

      - name: Save environment name for cleanup
        run: echo "wp-saml-auth.ci-${{ github.run_id }}" > site_env.txt

      - name: Upload environment name artifact
        uses: actions/upload-artifact@v4
        with:
          name: behat-env-${{ matrix.simplesamlphp_version }}
          path: site_env.txt

      - name: Validate fixture version
        uses: jazzsequence/action-validate-plugin-version@v1
        with:
          branch: ${{ github.head_ref }}
          dry-run: 'true'

      - name: Prepare and run Behat tests
        run: |
          set -e
          if [ "${{ matrix.simplesamlphp_version }}" != '1.18.0' ]; then
            bash ./bin/behat-prepare.sh
          else
            bash ./bin/1.18/behat-prepare-simplesaml1.18.0.sh
          fi

          echo ""
          echo "=========================================================================="
          echo "Running Behat on https://${TERMINUS_ENV}-${TERMINUS_SITE}.pantheonsite.io/wp-login.php"
          echo "with SimpleSAMLphp version $SIMPLESAMLPHP_VERSION"
          echo "=========================================================================="
          echo ""
          bash ./bin/behat-test.sh --strict

  # Cleanup job â€” always runs after Behat matrix completes
  behat-cleanup:
    name: "Behat Cleanup"
    runs-on: ubuntu-latest
    needs: test-behat
    if: always() && (github.event_name != 'schedule' || (github.event_name == 'schedule' && github.ref == 'refs/heads/master'))

    env:
      TERMINUS_SITE: wp-saml-auth
      TERMINUS_TOKEN: ${{ secrets.TERMINUS_TOKEN }}
      TERMINUS_ENV: cleanup-${{ github.run_number }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Download all environment name artifacts
        uses: actions/download-artifact@v4
        with:
          path: /tmp/behat-envs

      - name: Install Terminus
        uses: pantheon-systems/terminus-github-actions@v1
        with:
          pantheon-machine-token: ${{ secrets.TERMINUS_TOKEN }}

      - name: Run Cleanup Script
        run: |
          echo "The following environments will be cleaned up:"
          find /tmp/behat-envs -type f -name "*.txt" -exec cat {} +
          export TERMINUS_ENVS=$(find /tmp/behat-envs -type f -name "*.txt" -exec cat {} + | tr '\n' ' ')
          bash ./bin/behat-cleanup.sh
