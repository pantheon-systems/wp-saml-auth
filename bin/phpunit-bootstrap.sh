#!/usr/bin/env bash
set -euo pipefail

# ------------------------------------------------------------------------------
# WordPress PHPUnit bootstrap (matrix-safe)
# - Installs unzip, subversion
# - Ensures yoast/phpunit-polyfills is installed
# - Downloads WP core to WP_CORE_DIR
# - Exports tests lib to WP_TESTS_DIR with `svn export --force`
# - Writes a COMPLETE wp-tests-config.php with required constants
# ------------------------------------------------------------------------------

# ------- Config from env (with sane defaults) -------
WP_CORE_DIR="${WP_CORE_DIR:-/tmp/wordpress}"
WP_TESTS_DIR="${WP_TESTS_DIR:-/tmp/wordpress-tests-lib}"

DB_HOST="${DB_HOST:-127.0.0.1}"
DB_USER="${DB_USER:-root}"
DB_PASSWORD="${DB_PASSWORD:-root}"
DB_NAME="${DB_NAME:-wp_test}"
DB_CHARSET="${DB_CHARSET:-utf8}"
DB_COLLATE="${DB_COLLATE:-}"

TABLE_PREFIX="${TABLE_PREFIX:-wptests_}"

# Optional explicit WP version (otherwise latest.zip)
WP_VERSION="${WP_VERSION:-}"

# ------- Helpers -------
log(){ printf '== %s ==\n' "$*"; }

# ------- Deps -------
log "Ensuring dependencies..."
if ! command -v unzip >/dev/null 2>&1 || ! command -v svn >/dev/null 2>&1; then
  sudo apt-get update -y -qq
  sudo apt-get install -y -qq unzip subversion >/dev/null
fi

# ------- Ensure PHPUnit Polyfills (fixes PHP 7.4 error) -------
# We install it only if autoload is missing.
POLY_ROOT="vendor/yoast/phpunit-polyfills"
POLY_AUTO="${POLY_ROOT}/phpunitpolyfills-autoload.php"
if [[ ! -f "$POLY_AUTO" ]]; then
  if command -v composer >/dev/null 2>&1; then
    log "Installing yoast/phpunit-polyfills (dev) via Composer..."
    # ^1 works on PHP 7.4 and up. If your matrix includes newer PHP/PHPUnit,
    # Composer may upgrade it appropriately during dependency resolution.
    composer require --no-progress --no-scripts --no-interaction --dev yoast/phpunit-polyfills:^1 || {
      echo "Composer install of yoast/phpunit-polyfills failed"; exit 1;
    }
  else
    echo "Composer not available and polyfills missing: cannot continue."
    exit 1
  fi
fi

# ------- Download WP core (idempotent) -------
log "Downloading WordPress core into ${WP_CORE_DIR}..."
mkdir -p "${WP_CORE_DIR}"
if [[ ! -f "${WP_CORE_DIR}/wp-settings.php" ]]; then
  tmpdir="$(mktemp -d)"
  trap 'rm -rf "${tmpdir}"' EXIT

  if [[ -n "${WP_VERSION}" ]]; then
    CORE_URL="https://wordpress.org/wordpress-${WP_VERSION}.zip"
  else
    CORE_URL="https://wordpress.org/latest.zip"
  fi

  curl -fsSL "${CORE_URL}" -o "${tmpdir}/wordpress.zip"
  unzip -q "${tmpdir}/wordpress.zip" -d "${tmpdir}"
  rsync -a --delete "${tmpdir}/wordpress/" "${WP_CORE_DIR}/"
fi

# Determine version in core
WP_VER_IN_CORE="$(
  php -r "include '${WP_CORE_DIR}/wp-includes/version.php'; echo isset(\$wp_version)?\$wp_version:'';"
)"
log "  WP_VERSION=${WP_VER_IN_CORE:-unknown}"

# ------- Prepare WP tests lib (matrix-safe) -------
log "Preparing WP tests lib in ${WP_TESTS_DIR} (WP ${WP_VER_IN_CORE})"
mkdir -p "${WP_TESTS_DIR}"

SVN_BASE="https://develop.svn.wordpress.org"
if [[ -n "${WP_VER_IN_CORE}" ]] && svn ls "${SVN_BASE}/tags/${WP_VER_IN_CORE}/tests/phpunit" >/dev/null 2>&1; then
  SVN_PATH="${SVN_BASE}/tags/${WP_VER_IN_CORE}/tests/phpunit"
else
  echo "Tag checkout failed; using trunk tests/phpunitâ€¦"
  SVN_PATH="${SVN_BASE}/trunk/tests/phpunit"
fi

# Export (or re-export) in-place
svn export --force -q "${SVN_PATH}" "${WP_TESTS_DIR}"

# ------- Create full wp-tests-config.php (fixes missing constants) -------
log "Creating wp-tests-config.php"

# Absolute path to polyfills root for WP_TESTS_PHPUNIT_POLYFILLS_PATH
POLY_ROOT_ABS="$(cd "$(dirname "${POLY_AUTO}")/.." && pwd)"

: "${WP_TESTS_DOMAIN:=example.org}"
: "${WP_TESTS_EMAIL:=admin@example.org}"
: "${WP_TESTS_TITLE:=Test Blog}"
: "${WP_PHP_BINARY:=$(command -v php)}"

cat > "${WP_TESTS_DIR}/wp-tests-config.php" <<PHP
<?php
// Auto-generated by phpunit-bootstrap.sh

define( 'DB_NAME', '${DB_NAME}' );
define( 'DB_USER', '${DB_USER}' );
define( 'DB_PASSWORD', '${DB_PASSWORD}' );
define( 'DB_HOST', '${DB_HOST}' );
define( 'DB_CHARSET', '${DB_CHARSET}' );
define( 'DB_COLLATE', '${DB_COLLATE}' );

\$table_prefix = '${TABLE_PREFIX}';

define( 'WP_TESTS_DOMAIN', '${WP_TESTS_DOMAIN}' );
define( 'WP_TESTS_EMAIL', '${WP_TESTS_EMAIL}' );
define( 'WP_TESTS_TITLE', '${WP_TESTS_TITLE}' );
define( 'WP_PHP_BINARY', '${WP_PHP_BINARY}' );

// WP core path for tests
define( 'ABSPATH', '${WP_CORE_DIR}/' );

// PHPUnit Polyfills root dir (fixes "autoload not found" error)
define( 'WP_TESTS_PHPUNIT_POLYFILLS_PATH', '${POLY_ROOT_ABS}/' );

// CI niceties
define( 'FS_METHOD', 'direct' );
define( 'WP_DEBUG', true );
define( 'WP_DEBUG_DISPLAY', true );
PHP

log "Bootstrap complete."
