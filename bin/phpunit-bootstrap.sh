#!/usr/bin/env bash
set -euo pipefail

# ------------------------------------------------------------------------------
# WordPress PHPUnit bootstrap (matrix-safe)
# - Installs minimal deps (unzip, subversion)
# - Downloads WP core to WP_CORE_DIR (idempotent, no nested mv)
# - Exports WP tests lib with `svn export --force` (parallel-safe)
# - Writes wp-tests-config.php directly (no sample file needed)
# ------------------------------------------------------------------------------

# ------- Config from env (with sane defaults) -------
WP_CORE_DIR="${WP_CORE_DIR:-/tmp/wordpress}"
WP_TESTS_DIR="${WP_TESTS_DIR:-/tmp/wordpress-tests-lib}"

DB_HOST="${DB_HOST:-127.0.0.1}"
DB_USER="${DB_USER:-root}"
DB_PASSWORD="${DB_PASSWORD:-root}"
DB_NAME="${DB_NAME:-wp_test}"
DB_CHARSET="${DB_CHARSET:-utf8}"
DB_COLLATE="${DB_COLLATE:-}"

TABLE_PREFIX="${TABLE_PREFIX:-wptests_}"

# ------- Logging helper -------
log() { printf '== %s ==\n' "$*"; }

# ------- Deps -------
log "Ensuring dependencies..."
if ! command -v unzip >/dev/null 2>&1 || ! command -v svn >/dev/null 2>&1; then
  sudo apt-get update -y -qq
  # unzip for core, subversion for test suite export
  sudo apt-get install -y -qq unzip subversion >/dev/null
fi

# ------- Download WP core (idempotent) -------
log "Downloading WordPress core into ${WP_CORE_DIR}..."
mkdir -p "${WP_CORE_DIR}"
if [[ ! -f "${WP_CORE_DIR}/wp-settings.php" ]]; then
  tmpdir="$(mktemp -d)"
  trap 'rm -rf "${tmpdir}"' EXIT

  # If WP_VERSION provided, use that, else grab latest
  WP_VERSION="${WP_VERSION:-}"
  if [[ -n "${WP_VERSION}" ]]; then
    CORE_URL="https://wordpress.org/wordpress-${WP_VERSION}.zip"
  else
    CORE_URL="https://wordpress.org/latest.zip"
  fi

  curl -fsSL "${CORE_URL}" -o "${tmpdir}/wordpress.zip"
  unzip -q "${tmpdir}/wordpress.zip" -d "${tmpdir}"

  # Move contents safely into WP_CORE_DIR
  # (Avoid "mv to a subdirectory of itself" by moving inner dir only.)
  rsync -a --delete "${tmpdir}/wordpress/" "${WP_CORE_DIR}/"
fi

# Determine version in core
WP_VER_IN_CORE="$(
  php -r "include '${WP_CORE_DIR}/wp-includes/version.php'; echo isset(\$wp_version)?\$wp_version:'';"
)"
log "  WP_VERSION=${WP_VER_IN_CORE:-unknown}"

# ------- Prepare WP tests lib (matrix-safe) -------
log "Preparing WP tests lib in ${WP_TESTS_DIR} (WP ${WP_VER_IN_CORE})"
mkdir -p "${WP_TESTS_DIR}"

SVN_BASE="https://develop.svn.wordpress.org"
# Prefer tag that matches core; fallback to trunk if tag path isn’t found
if [[ -n "${WP_VER_IN_CORE}" ]] && svn ls "${SVN_BASE}/tags/${WP_VER_IN_CORE}/tests/phpunit" >/dev/null 2>&1; then
  SVN_PATH="${SVN_BASE}/tags/${WP_VER_IN_CORE}/tests/phpunit"
else
  echo "Tag checkout failed; using trunk tests/phpunit…"
  SVN_PATH="${SVN_BASE}/trunk/tests/phpunit"
fi

# Export with --force so parallel jobs can re-export over the same path
svn export --force -q "${SVN_PATH}" "${WP_TESTS_DIR}"

# ------- Create wp-tests-config.php directly -------
log "Creating wp-tests-config.php"
cat > "${WP_TESTS_DIR}/wp-tests-config.php" <<PHP
<?php
// Auto-generated by phpunit-bootstrap.sh

define( 'DB_NAME', '${DB_NAME}' );
define( 'DB_USER', '${DB_USER}' );
define( 'DB_PASSWORD', '${DB_PASSWORD}' );
define( 'DB_HOST', '${DB_HOST}' );
define( 'DB_CHARSET', '${DB_CHARSET}' );
define( 'DB_COLLATE', '${DB_COLLATE}' );

\$table_prefix = '${TABLE_PREFIX}';

// Point tests at the downloaded core
define( 'ABSPATH', '${WP_CORE_DIR}/' );

// Allow direct filesystem access in CI
define( 'FS_METHOD', 'direct' );

// Useful toggles for CI stability
define( 'WP_DEBUG', true );
define( 'WP_DEBUG_DISPLAY', true );
PHP

log "Bootstrap complete."
